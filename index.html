<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chart - BTC/USDC</title>
    <!-- CSP assouplie pour le dev local -->
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data: https:; style-src 'self' 'unsafe-inline'; script-src 'self' blob: https://cdn.jsdelivr.net https://vercel.live; worker-src 'self' blob:; connect-src 'self' https://api.binance.com wss://stream.binance.com:9443 https://*.supabase.co https://*.supabase.net wss://*.supabase.co wss://*.supabase.net https://vercel.live; frame-src https://vercel.live; font-src 'self' data:;">
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <!-- Preloader overlay -->
    <div id="preloadOverlay">
      <div id="preloadClip">
        <div id="preloadSheet">
          <video id="preloadVideo" src="assets/preload.mp4" muted playsinline autoplay></video>
          <canvas id="preloadCanvas" style="display:none;"></canvas>
          <div id="preloadCreases"></div>
        </div>
        <canvas id="preloadGL"></canvas>
        <canvas id="preloadRoulette"></canvas>
        <div id="preloadPlane"></div>
      </div>
    </div>
    <!-- Inline SVG filters for paper displacement -->
    <svg id="preloadFilters" width="0" height="0" style="position:absolute; width:0; height:0; overflow:hidden;">
      <defs>
        <filter id="paperDisplaceWeak" x="-10%" y="-10%" width="120%" height="120%">
          <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" seed="7" result="noise"/>
          <feDisplacementMap in="SourceGraphic" in2="noise" scale="3" xChannelSelector="R" yChannelSelector="B"/>
        </filter>
        <filter id="paperDisplaceStrong" x="-10%" y="-10%" width="120%" height="120%">
          <feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="2" seed="11" result="noise2"/>
          <feDisplacementMap in="SourceGraphic" in2="noise2" scale="6" xChannelSelector="R" yChannelSelector="G"/>
        </filter>
        <filter id="paperDisplacePro" x="-12%" y="-12%" width="124%" height="124%">
          <feTurbulence type="fractalNoise" baseFrequency="0.55" numOctaves="3" seed="23" result="tex"/>
          <feGaussianBlur in="tex" stdDeviation="0.6" result="btex"/>
          <feDisplacementMap in="SourceGraphic" in2="btex" scale="8" xChannelSelector="R" yChannelSelector="B"/>
        </filter>
      </defs>
    </svg>
    <header>
      <img id="brandLogo" src="assets/botrade_header.png" alt="botrade" class="brand-logo" />
      <h1 id="pairTitle" style="display:none">BTC/USDC</h1>
        <div class="controls">
          <label for="symbol" data-i18n="header.symbolLabel">Symbole</label>
        <select id="symbol">
          <option value="BTCUSDC" selected>BTC/USDC</option>
          <option value="ETHUSDC">ETH/USDC</option>
          <option value="BNBUSDC">BNB/USDC</option>
        </select>
        <label for="interval" data-i18n="header.intervalLabel">Intervalle</label>
        <select id="interval">
          <option value="1m">1m</option>
          <option value="5m">5m</option>
          <option value="15m">15m</option>
          <option value="1h" selected>1h</option>
          <option value="4h">4h</option>
          <option value="1d">1d</option>
        </select>
        <label class="hdr-toggle" id="emaCtrl" title="Activer/Désactiver l'affichage des EMA/MA" data-i18n-title="header.emaToggleTitle">
          <input id="emaToggle" type="checkbox" checked />
          <button id="emaCfg" class="link-btn" type="button" title="Paramètres EMA/MA" data-i18n-title="header.emaCfgTitle">EMA ⚙</button>
        </label>
        <label class="hdr-toggle" id="heavenCtrl" title="Activer/Désactiver Heaven" data-i18n-title="header.heavenToggleTitle">
          <input id="toggleLBC" type="checkbox" />
          <button id="heavenCfg" class="link-btn" type="button" title="Paramètres Heaven" data-i18n-title="header.heavenCfgTitle">Heaven ⚙</button>
        </label>
        <button id="btRunVisible" class="btn" data-i18n="header.btRun">Backtest</button>
        <button id="labOpen" class="btn" title="Recherche/Apprentissage par TF" data-i18n="header.lab" data-i18n-title="header.labTitle">Lab</button>
        <button id="globalPalmaresBtn" class="btn" title="Palmarès global (tous symboles &amp; TF)">Palmarès global</button>
        <button id="liveOpen" class="btn" title="Paper/Live trading" data-i18n="header.live" data-i18n-title="header.liveTitle">Live</button>
        <button id="supaCfgBtn" class="btn" title="Configurer Supabase" data-i18n="header.supaBtn" data-i18n-title="header.supaTitle">Supabase</button>
        <button id="themeToggle" class="btn" title="Basculer thème (Auto → Sombre → Clair)">Thème: Auto</button>
        <button id="langToggle" class="btn" title="Changer la langue (FR → EN → ES)">Langue: FR</button>
        <span id="status" class="status"></span>
        <span id="barsInfo" class="status"></span>
      </div>
    </header>
    <main>
      <div id="chart">
      <div id="lbc-overlay" class="lbc-overlay">
          <div id="lbc-prob" class="lbc-card hidden"></div>
          <div id="lbc-table" class="lbc-card hidden"></div>
        </div>
        <button id="gotoEndBtn" class="btn" data-i18n="header.gotoEnd">⏭ Aller à la fin</button>
      </div>
    </main>

    <div id="lbcModal" class="modal hidden" aria-hidden="true" role="dialog">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h2>Paramètres Heaven</h2>
          <button id="lbcClose" class="icon-btn" aria-label="Fermer">×</button>
        </div>
        <div class="modal-body">
          <form id="lbcForm" class="form-grid">
            <fieldset>
              <legend>Général</legend>
              <label><input type="checkbox" id="optEnabled" /> Activer Heaven</label>
              <label>NOL <input id="optNol" type="number" min="1" value="3" style="width:4.5rem" /></label>
              <label><input type="checkbox" id="optRiskMgmt" /> Gestion du risque</label>
              <label>Max Risk % <input id="optRiskPct" type="number" min="0" step="0.1" value="1.0" style="width:5.5rem" /></label>
              <label><input type="checkbox" id="optShowTrend" checked /> Trendline (reversal)</label>
              <label>Trend Up <input id="optTrendUp" type="color" value="#00ff00" /></label>
              <label>Trend Down <input id="optTrendDn" type="color" value="#ff0000" /></label>
              <label><input type="checkbox" id="optShowClose" checked /> Ligne de clôture</label>
              <label><input type="checkbox" id="optShowArrows" checked /> Afficher flèches (entrées)</label>
<label>Offset (px) <input id="optArrowOffsetPx" type="number" min="0" step="1" value="50" style="width:5rem" /></label>
              <label>Entry Mode
                <select id="optEntryMode">
                  <option value="Original">Original</option>
                  <option value="Fib Retracement">Fib Retracement</option>
                  <option value="Both" selected>Both</option>
                </select>
              </label>
            </fieldset>
            <fieldset>
              <legend>ZigZag & Fibonacci</legend>
              <label>Période (prd) <input id="optPrd" type="number" min="2" max="50" value="15" style="width:4.5rem" /></label>
              <label><input type="checkbox" id="optUseZZDraw" checked /> Dessiner ZigZag</label>
              <label><input type="checkbox" id="optUseFibDraw" checked /> Dessiner Fibonacci</label>
              <label>ZigZag Up <input id="optZZUp" type="color" value="#00ff00" /></label>
              <label>ZigZag Down <input id="optZZDn" type="color" value="#ff0000" /></label>
              <label><input type="checkbox" id="optUseFibRet" /> Entrées Fib</label>
              <label>Confirmation
                <select id="optConfirmMode">
                  <option value="Bounce" selected>Bounce</option>
                  <option value="Touch">Touch</option>
                </select>
              </label>
              <label><input type="checkbox" id="optEnt382" checked /> 0.382</label>
              <label><input type="checkbox" id="optEnt500" checked /> 0.500</label>
              <label><input type="checkbox" id="optEnt618" checked /> 0.618</label>
              <label><input type="checkbox" id="optEnt786" /> 0.786</label>
            </fieldset>
            <fieldset>
              <legend>Cibles & Stops (TP + SL + BE) — par TP uniquement</legend>
              <p style="color:var(--muted); font-size:12px; margin:4px 0;">Info: Les stops sont définis uniquement par TP. Utilisez « SLi … » et « BE à ce TP » pour chaque cible.</p>
              <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 10px;">
                <div>
                  <label>TP1 type
                    <select id="optTP1Type">
                      <option value="Fib" selected>Fibonacci</option>
                      <option value="Percent">Percent</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>TP1 target
                    <input id="optTP1R" type="number" step="0.001" value="0.382" style="width:6rem" />
                    <select id="optTP1Fib" style="width:8rem; display:none;">
                      <option value="0">0.000</option>
                      <option value="0.236">0.236</option>
                      <option value="0.382">0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                      <option value="2.618">2.618</option>
                      <option value="3">3.000</option>
                      <option value="3.618">3.618</option>
                      <option value="4.236">4.236</option>
                      <option value="5">5.000</option>
                    </select>
                    <select id="optTP1Ema" style="width:8rem; display:none;"></select>
                  </label>
                  <label>SL1 type
                    <select id="optTP1SLType">
                      <option value="Percent" selected>Percent</option>
                      <option value="Fib">Fibonacci</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>SL1 value
                    <input id="optTP1SLR" type="number" step="0.001" value="2.000" style="width:6rem" />
                    <select id="optTP1SLFib" style="width:8rem; display:none;">
                      <option value="0.236">0.236</option>
                      <option value="0.382" selected>0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                    </select>
                    <select id="optTP1SLEma" style="width:8rem; display:none;"></select>
                  </label>
                  <label><input type="checkbox" id="optTP1BEOn" /> BE à ce TP</label>
                  <label>% capital TP1 <input id="optTP1P" type="number" min="0" max="100" step="1" value="10" style="width:5rem" /></label>
                  <label>TP1 trailing
                    <select id="optTP1TrailType">
                      <option value="none" selected>Aucun</option>
                      <option value="be">BE</option>
                      <option value="prev">Précédent</option>
                      <option value="ema">EMA</option>
                      <option value="percent">Percent</option>
                    </select>
                  </label>
                  <select id="optTP1TrailEma" style="width:8rem; display:none;"></select>
                  <input id="optTP1TrailPct" type="number" step="0.1" min="0" style="width:6rem; display:none;" />
                  <label>SL1 trailing
                    <select id="optTP1SLTrailType">
                      <option value="none" selected>Aucun</option>
                      <option value="ema">EMA</option>
                      <option value="percent">Percent</option>
                    </select>
                  </label>
                  <select id="optTP1SLTrailEma" style="width:8rem; display:none;"></select>
                  <input id="optTP1SLTrailPct" type="number" step="0.1" min="0" style="width:6rem; display:none;" />
                </div>
                <div>
                  <label>TP2 type
                    <select id="optTP2Type">
                      <option value="Fib" selected>Fibonacci</option>
                      <option value="Percent">Percent</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>TP2 target
                    <input id="optTP2R" type="number" step="0.001" value="0.500" style="width:6rem" />
                    <select id="optTP2Fib" style="width:8rem; display:none;">
                      <option value="0">0.000</option>
                      <option value="0.236">0.236</option>
                      <option value="0.382">0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                      <option value="2.618">2.618</option>
                      <option value="3">3.000</option>
                      <option value="3.618">3.618</option>
                      <option value="4.236">4.236</option>
                      <option value="5">5.000</option>
                    </select>
                    <select id="optTP2Ema" style="width:8rem; display:none;"></select>
                  </label>
                  <label>SL2 type
                    <select id="optTP2SLType">
                      <option value="Percent" selected>Percent</option>
                      <option value="Fib">Fibonacci</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>SL2 value
                    <input id="optTP2SLR" type="number" step="0.001" value="2.000" style="width:6rem" />
                    <select id="optTP2SLFib" style="width:8rem; display:none;">
                      <option value="0.236">0.236</option>
                      <option value="0.382" selected>0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                    </select>
                    <select id="optTP2SLEma" style="width:8rem; display:none;"></select>
                  </label>
                  <label><input type="checkbox" id="optTP2BEOn" /> BE à ce TP</label>
                  <label>% capital TP2 <input id="optTP2P" type="number" min="0" max="100" step="1" value="15" style="width:5rem" /></label>
                  <label>TP2 trailing
                    <select id="optTP2TrailType">
                      <option value="none" selected>Aucun</option>
                      <option value="be">BE</option>
                      <option value="prev">Précédent</option>
                      <option value="ema">EMA</option>
                      <option value="percent">Percent</option>
                    </select>
                  </label>
                  <select id="optTP2TrailEma" style="width:8rem; display:none;"></select>
                  <input id="optTP2TrailPct" type="number" step="0.1" min="0" style="width:6rem; display:none;" />
                  <label>SL2 trailing
                    <select id="optTP2SLTrailType">
                      <option value="none" selected>Aucun</option>
                      <option value="ema">EMA</option>
                      <option value="percent">Percent</option>
                    </select>
                  </label>
                  <select id="optTP2SLTrailEma" style="width:8rem; display:none;"></select>
                  <input id="optTP2SLTrailPct" type="number" step="0.1" min="0" style="width:6rem; display:none;" />
                </div>
                <div>
                  <label>TP3 type
                    <select id="optTP3Type">
                      <option value="Fib" selected>Fibonacci</option>
                      <option value="Percent">Percent</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>TP3 target
                    <input id="optTP3R" type="number" step="0.001" value="0.680" style="width:6rem" />
                    <select id="optTP3Fib" style="width:8rem; display:none;">
                      <option value="0">0.000</option>
                      <option value="0.236">0.236</option>
                      <option value="0.382">0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                      <option value="2.618">2.618</option>
                      <option value="3">3.000</option>
                      <option value="3.618">3.618</option>
                      <option value="4.236">4.236</option>
                      <option value="5">5.000</option>
                    </select>
                    <select id="optTP3Ema" style="width:8rem; display:none;"></select>
                  </label>
                  <label>SL3 type
                    <select id="optTP3SLType">
                      <option value="Percent" selected>Percent</option>
                      <option value="Fib">Fibonacci</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>SL3 value
                    <input id="optTP3SLR" type="number" step="0.001" value="2.000" style="width:6rem" />
                    <select id="optTP3SLFib" style="width:8rem; display:none;">
                      <option value="0.236">0.236</option>
                      <option value="0.382" selected>0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                    </select>
                    <select id="optTP3SLEma" style="width:8rem; display:none;"></select>
                  </label>
                  <label><input type="checkbox" id="optTP3BEOn" /> BE à ce TP</label>
                  <label>% capital TP3 <input id="optTP3P" type="number" min="0" max="100" step="1" value="15" style="width:5rem" /></label>
                  <label>TP3 trailing
                    <select id="optTP3TrailType">
                      <option value="none" selected>Aucun</option>
                      <option value="be">BE</option>
                      <option value="prev">Précédent</option>
                      <option value="ema">EMA</option>
                      <option value="percent">Percent</option>
                    </select>
                  </label>
                  <select id="optTP3TrailEma" style="width:8rem; display:none;"></select>
                  <input id="optTP3TrailPct" type="number" step="0.1" min="0" style="width:6rem; display:none;" />
                  <label>SL3 trailing
                    <select id="optTP3SLTrailType">
                      <option value="none" selected>Aucun</option>
                      <option value="ema">EMA</option>
                      <option value="percent">Percent</option>
                    </select>
                  </label>
                  <select id="optTP3SLTrailEma" style="width:8rem; display:none;"></select>
                  <input id="optTP3SLTrailPct" type="number" step="0.1" min="0" style="width:6rem; display:none;" />
                </div>
                <div>
                  <label>TP4 type
                    <select id="optTP4Type">
                      <option value="Fib" selected>Fibonacci</option>
                      <option value="Percent">Percent</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>TP4 target
                    <input id="optTP4R" type="number" step="0.001" value="1.000" style="width:6rem" />
                    <select id="optTP4Fib" style="width:8rem; display:none;">
                      <option value="0">0.000</option>
                      <option value="0.236">0.236</option>
                      <option value="0.382">0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                      <option value="2.618">2.618</option>
                      <option value="3">3.000</option>
                      <option value="3.618">3.618</option>
                      <option value="4.236">4.236</option>
                      <option value="5">5.000</option>
                    </select>
                    <select id="optTP4Ema" style="width:8rem; display:none;"></select>
                  </label>
                  <label>SL4 type
                    <select id="optTP4SLType">
                      <option value="Percent" selected>Percent</option>
                      <option value="Fib">Fibonacci</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>SL4 value
                    <input id="optTP4SLR" type="number" step="0.001" value="2.000" style="width:6rem" />
                    <select id="optTP4SLFib" style="width:8rem; display:none;">
                      <option value="0.236">0.236</option>
                      <option value="0.382" selected>0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                    </select>
                    <select id="optTP4SLEma" style="width:8rem; display:none;"></select>
                  </label>
                  <label><input type="checkbox" id="optTP4BEOn" /> BE à ce TP</label>
                  <label>% capital TP4 <input id="optTP4P" type="number" min="0" max="100" step="1" value="10" style="width:5rem" /></label>
                  <label>TP4 trailing
                    <select id="optTP4TrailType">
                      <option value="none" selected>Aucun</option>
                      <option value="be">BE</option>
                      <option value="prev">Précédent</option>
                      <option value="ema">EMA</option>
                      <option value="percent">Percent</option>
                    </select>
                  </label>
                  <select id="optTP4TrailEma" style="width:8rem; display:none;"></select>
                  <input id="optTP4TrailPct" type="number" step="0.1" min="0" style="width:6rem; display:none;" />
                  <label>SL4 trailing
                    <select id="optTP4SLTrailType">
                      <option value="none" selected>Aucun</option>
                      <option value="ema">EMA</option>
                      <option value="percent">Percent</option>
                    </select>
                  </label>
                  <select id="optTP4SLTrailEma" style="width:8rem; display:none;"></select>
                  <input id="optTP4SLTrailPct" type="number" step="0.1" min="0" style="width:6rem; display:none;" />
                </div>
                <div>
                  <label>TP5 type
                    <select id="optTP5Type">
                      <option value="Fib" selected>Fibonacci</option>
                      <option value="Percent">Percent</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>TP5 target
                    <input id="optTP5R" type="number" step="0.001" value="1.382" style="width:6rem" />
                    <select id="optTP5Fib" style="width:8rem; display:none;">
                      <option value="0">0.000</option>
                      <option value="0.236">0.236</option>
                      <option value="0.382">0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                      <option value="2.618">2.618</option>
                      <option value="3">3.000</option>
                      <option value="3.618">3.618</option>
                      <option value="4.236">4.236</option>
                      <option value="5">5.000</option>
                    </select>
                    <select id="optTP5Ema" style="width:8rem; display:none;"></select>
                  </label>
                  <label>SL5 type
                    <select id="optTP5SLType">
                      <option value="Percent" selected>Percent</option>
                      <option value="Fib">Fibonacci</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>SL5 value
                    <input id="optTP5SLR" type="number" step="0.001" value="2.000" style="width:6rem" />
                    <select id="optTP5SLFib" style="width:8rem; display:none;">
                      <option value="0.236">0.236</option>
                      <option value="0.382" selected>0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                    </select>
                    <select id="optTP5SLEma" style="width:8rem; display:none;"></select>
                  </label>
                  <label><input type="checkbox" id="optTP5BEOn" /> BE à ce TP</label>
                  <label>% capital TP5 <input id="optTP5P" type="number" min="0" max="100" step="1" value="10" style="width:5rem" /></label>
                  <label>TP5 trailing
                    <select id="optTP5TrailType">
                      <option value="none" selected>Aucun</option>
                      <option value="be">BE</option>
                      <option value="prev">Précédent</option>
                      <option value="ema">EMA</option>
                      <option value="percent">Percent</option>
                    </select>
                  </label>
                  <select id="optTP5TrailEma" style="width:8rem; display:none;"></select>
                  <input id="optTP5TrailPct" type="number" step="0.1" min="0" style="width:6rem; display:none;" />
                  <label>SL5 trailing
                    <select id="optTP5SLTrailType">
                      <option value="none" selected>Aucun</option>
                      <option value="ema">EMA</option>
                      <option value="percent">Percent</option>
                    </select>
                  </label>
                  <select id="optTP5SLTrailEma" style="width:8rem; display:none;"></select>
                  <input id="optTP5SLTrailPct" type="number" step="0.1" min="0" style="width:6rem; display:none;" />
                </div>
                <div>
                  <label>TP6 type
                    <select id="optTP6Type">
                      <option value="Fib" selected>Fibonacci</option>
                      <option value="Percent">Percent</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>TP6 target
                    <input id="optTP6R" type="number" step="0.001" value="1.618" style="width:6rem" />
                    <select id="optTP6Fib" style="width:8rem; display:none;">
                      <option value="0">0.000</option>
                      <option value="0.236">0.236</option>
                      <option value="0.382">0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                      <option value="2.618">2.618</option>
                      <option value="3">3.000</option>
                      <option value="3.618">3.618</option>
                      <option value="4.236">4.236</option>
                      <option value="5">5.000</option>
                    </select>
                    <select id="optTP6Ema" style="width:8rem; display:none;"></select>
                  </label>
                  <label>SL6 type
                    <select id="optTP6SLType">
                      <option value="Percent" selected>Percent</option>
                      <option value="Fib">Fibonacci</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>SL6 value
                    <input id="optTP6SLR" type="number" step="0.001" value="2.000" style="width:6rem" />
                    <select id="optTP6SLFib" style="width:8rem; display:none;">
                      <option value="0.236">0.236</option>
                      <option value="0.382" selected>0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                    </select>
                    <select id="optTP6SLEma" style="width:8rem; display:none;"></select>
                  </label>
                  <label><input type="checkbox" id="optTP6BEOn" /> BE à ce TP</label>
                  <label>% capital TP6 <input id="optTP6P" type="number" min="0" max="100" step="1" value="10" style="width:5rem" /></label>
                  <label>TP6 trailing
                    <select id="optTP6TrailType">
                      <option value="none" selected>Aucun</option>
                      <option value="be">BE</option>
                      <option value="prev">Précédent</option>
                      <option value="ema">EMA</option>
                      <option value="percent">Percent</option>
                    </select>
                  </label>
                  <select id="optTP6TrailEma" style="width:8rem; display:none;"></select>
                  <input id="optTP6TrailPct" type="number" step="0.1" min="0" style="width:6rem; display:none;" />
                  <label>SL6 trailing
                    <select id="optTP6SLTrailType">
                      <option value="none" selected>Aucun</option>
                      <option value="ema">EMA</option>
                      <option value="percent">Percent</option>
                    </select>
                  </label>
                  <select id="optTP6SLTrailEma" style="width:8rem; display:none;"></select>
                  <input id="optTP6SLTrailPct" type="number" step="0.1" min="0" style="width:6rem; display:none;" />
                </div>
                <div>
                  <label>TP7 type
                    <select id="optTP7Type">
                      <option value="Fib" selected>Fibonacci</option>
                      <option value="Percent">Percent</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>TP7 target
                    <input id="optTP7R" type="number" step="0.001" value="2.000" style="width:6rem" />
                    <select id="optTP7Fib" style="width:8rem; display:none;">
                      <option value="0">0.000</option>
                      <option value="0.236">0.236</option>
                      <option value="0.382">0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                      <option value="2.618">2.618</option>
                      <option value="3">3.000</option>
                      <option value="3.618">3.618</option>
                      <option value="4.236">4.236</option>
                      <option value="5">5.000</option>
                    </select>
                    <select id="optTP7Ema" style="width:8rem; display:none;"></select>
                  </label>
                  <label>SL7 type
                    <select id="optTP7SLType">
                      <option value="Percent" selected>Percent</option>
                      <option value="Fib">Fibonacci</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>SL7 value
                    <input id="optTP7SLR" type="number" step="0.001" value="2.000" style="width:6rem" />
                    <select id="optTP7SLFib" style="width:8rem; display:none;">
                      <option value="0.236">0.236</option>
                      <option value="0.382" selected>0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                    </select>
                    <select id="optTP7SLEma" style="width:8rem; display:none;"></select>
                  </label>
                  <label><input type="checkbox" id="optTP7BEOn" /> BE à ce TP</label>
                  <label>% capital TP7 <input id="optTP7P" type="number" min="0" max="100" step="1" value="10" style="width:5rem" /></label>
                  <label>TP7 trailing
                    <select id="optTP7TrailType">
                      <option value="none" selected>Aucun</option>
                      <option value="be">BE</option>
                      <option value="prev">Précédent</option>
                      <option value="ema">EMA</option>
                      <option value="percent">Percent</option>
                    </select>
                  </label>
                  <select id="optTP7TrailEma" style="width:8rem; display:none;"></select>
                  <input id="optTP7TrailPct" type="number" step="0.1" min="0" style="width:6rem; display:none;" />
                  <label>SL7 trailing
                    <select id="optTP7SLTrailType">
                      <option value="none" selected>Aucun</option>
                      <option value="ema">EMA</option>
                      <option value="percent">Percent</option>
                    </select>
                  </label>
                  <select id="optTP7SLTrailEma" style="width:8rem; display:none;"></select>
                  <input id="optTP7SLTrailPct" type="number" step="0.1" min="0" style="width:6rem; display:none;" />
                </div>
                <div>
                  <label>TP8 type
                    <select id="optTP8Type">
                      <option value="Fib" selected>Fibonacci</option>
                      <option value="Percent">Percent</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>TP8 target
                    <input id="optTP8R" type="number" step="0.001" value="2.236" style="width:6rem" />
                    <select id="optTP8Fib" style="width:8rem; display:none;">
                      <option value="0">0.000</option>
                      <option value="0.236">0.236</option>
                      <option value="0.382">0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                      <option value="2.618">2.618</option>
                      <option value="3">3.000</option>
                      <option value="3.618">3.618</option>
                      <option value="4.236">4.236</option>
                      <option value="5">5.000</option>
                    </select>
                    <select id="optTP8Ema" style="width:8rem; display:none;"></select>
                  </label>
                  <label>SL8 type
                    <select id="optTP8SLType">
                      <option value="Percent" selected>Percent</option>
                      <option value="Fib">Fibonacci</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>SL8 value
                    <input id="optTP8SLR" type="number" step="0.001" value="2.000" style="width:6rem" />
                    <select id="optTP8SLFib" style="width:8rem; display:none;">
                      <option value="0.236">0.236</option>
                      <option value="0.382" selected>0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                    </select>
                    <select id="optTP8SLEma" style="width:8rem; display:none;"></select>
                  </label>
                  <label><input type="checkbox" id="optTP8BEOn" /> BE à ce TP</label>
                  <label>% capital TP8 <input id="optTP8P" type="number" min="0" max="100" step="1" value="10" style="width:5rem" /></label>
                  <label>TP8 trailing
                    <select id="optTP8TrailType">
                      <option value="none" selected>Aucun</option>
                      <option value="be">BE</option>
                      <option value="prev">Précédent</option>
                      <option value="ema">EMA</option>
                      <option value="percent">Percent</option>
                    </select>
                  </label>
                  <select id="optTP8TrailEma" style="width:8rem; display:none;"></select>
                  <input id="optTP8TrailPct" type="number" step="0.1" min="0" style="width:6rem; display:none;" />
                  <label>SL8 trailing
                    <select id="optTP8SLTrailType">
                      <option value="none" selected>Aucun</option>
                      <option value="ema">EMA</option>
                      <option value="percent">Percent</option>
                    </select>
                  </label>
                  <select id="optTP8SLTrailEma" style="width:8rem; display:none;"></select>
                  <input id="optTP8SLTrailPct" type="number" step="0.1" min="0" style="width:6rem; display:none;" />
                </div>
                <div>
                  <label>TP9 type
                    <select id="optTP9Type">
                      <option value="Fib" selected>Fibonacci</option>
                      <option value="Percent">Percent</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>TP9 target
                    <input id="optTP9R" type="number" step="0.001" value="2.618" style="width:6rem" />
                    <select id="optTP9Fib" style="width:8rem; display:none;">
                      <option value="0">0.000</option>
                      <option value="0.236">0.236</option>
                      <option value="0.382">0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                      <option value="2.618">2.618</option>
                      <option value="3">3.000</option>
                      <option value="3.618">3.618</option>
                      <option value="4.236">4.236</option>
                      <option value="5">5.000</option>
                    </select>
                    <select id="optTP9Ema" style="width:8rem; display:none;"></select>
                  </label>
                  <label>SL9 type
                    <select id="optTP9SLType">
                      <option value="Percent" selected>Percent</option>
                      <option value="Fib">Fibonacci</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>SL9 value
                    <input id="optTP9SLR" type="number" step="0.001" value="2.000" style="width:6rem" />
                    <select id="optTP9SLFib" style="width:8rem; display:none;">
                      <option value="0.236">0.236</option>
                      <option value="0.382" selected>0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                    </select>
                    <select id="optTP9SLEma" style="width:8rem; display:none;"></select>
                  </label>
                  <label><input type="checkbox" id="optTP9BEOn" /> BE à ce TP</label>
                  <label>% capital TP9 <input id="optTP9P" type="number" min="0" max="100" step="1" value="5" style="width:5rem" /></label>
                  <label>TP9 trailing
                    <select id="optTP9TrailType">
                      <option value="none" selected>Aucun</option>
                      <option value="be">BE</option>
                      <option value="prev">Précédent</option>
                      <option value="ema">EMA</option>
                      <option value="percent">Percent</option>
                    </select>
                  </label>
                  <select id="optTP9TrailEma" style="width:8rem; display:none;"></select>
                  <input id="optTP9TrailPct" type="number" step="0.1" min="0" style="width:6rem; display:none;" />
                  <label>SL9 trailing
                    <select id="optTP9SLTrailType">
                      <option value="none" selected>Aucun</option>
                      <option value="ema">EMA</option>
                      <option value="percent">Percent</option>
                    </select>
                  </label>
                  <select id="optTP9SLTrailEma" style="width:8rem; display:none;"></select>
                  <input id="optTP9SLTrailPct" type="number" step="0.1" min="0" style="width:6rem; display:none;" />
                </div>
                <div>
                  <label>TP10 type
                    <select id="optTP10Type">
                      <option value="Fib" selected>Fibonacci</option>
                      <option value="Percent">Percent</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>TP10 target
                    <input id="optTP10R" type="number" step="0.001" value="3.000" style="width:6rem" />
                    <select id="optTP10Fib" style="width:8rem; display:none;">
                      <option value="0">0.000</option>
                      <option value="0.236">0.236</option>
                      <option value="0.382">0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                      <option value="2.618">2.618</option>
                      <option value="3">3.000</option>
                      <option value="3.618">3.618</option>
                      <option value="4.236">4.236</option>
                      <option value="5">5.000</option>
                    </select>
                    <select id="optTP10Ema" style="width:8rem; display:none;"></select>
                  </label>
                  <label>SL10 type
                    <select id="optTP10SLType">
                      <option value="Percent" selected>Percent</option>
                      <option value="Fib">Fibonacci</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>SL10 value
                    <input id="optTP10SLR" type="number" step="0.001" value="2.000" style="width:6rem" />
                    <select id="optTP10SLFib" style="width:8rem; display:none;">
                      <option value="0.236">0.236</option>
                      <option value="0.382" selected>0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                    </select>
                    <select id="optTP10SLEma" style="width:8rem; display:none;"></select>
                  </label>
                  <label><input type="checkbox" id="optTP10BEOn" /> BE à ce TP</label>
                  <label>% capital TP10 <input id="optTP10P" type="number" min="0" max="100" step="1" value="5" style="width:5rem" /></label>
                  <label>TP10 trailing
                    <select id="optTP10TrailType">
                      <option value="none" selected>Aucun</option>
                      <option value="be">BE</option>
                      <option value="prev">Précédent</option>
                      <option value="ema">EMA</option>
                      <option value="percent">Percent</option>
                    </select>
                  </label>
                  <select id="optTP10TrailEma" style="width:8rem; display:none;"></select>
                  <input id="optTP10TrailPct" type="number" step="0.1" min="0" style="width:6rem; display:none;" />
                  <label>SL10 trailing
                    <select id="optTP10SLTrailType">
                      <option value="none" selected>Aucun</option>
                      <option value="ema">EMA</option>
                      <option value="percent">Percent</option>
                    </select>
                  </label>
                  <select id="optTP10SLTrailEma" style="width:8rem; display:none;"></select>
                  <input id="optTP10SLTrailPct" type="number" step="0.1" min="0" style="width:6rem; display:none;" />
                </div>
              </div>
            </fieldset>
          </form>
        </div>
        <div class="modal-footer" style="flex-wrap:wrap; gap:8px; align-items:center;">
          <div style="display:flex; gap:6px; align-items:center; flex:1 1 auto; min-width:260px;">
            <input id="lbcSupaName" type="text" placeholder="Nom" style="flex:1 1 auto; min-width:160px;" data-i18n-placeholder="heaven.supa.namePlaceholder" />
            <button id="lbcSupaSave" class="btn" data-i18n="common.save">Enregistrer</button>
          </div>
          <div style="display:flex; gap:6px; align-items:center; flex:2 1 auto; min-width:320px;">
            <label>TF
              <select id="heavenTFSelect" style="min-width:8rem;"></select>
            </label>
            <label data-i18n="lab.weights.profileLabel">Profil
              <select id="heavenProfileSelect" style="min-width:10rem;">
                <option value="sure" data-i18n="lab.weights.profile.safe">Stratégie sûre</option>
                <option value="balancee" selected data-i18n="lab.weights.profile.bal">Stratégie balancée</option>
                <option value="agressive" data-i18n="lab.weights.profile.agg">Stratégie agressive</option>
              </select>
            </label>
            <select id="heavenLoadSelect" style="flex:1 1 auto; min-width:200px;"></select>
            <button id="heavenLoadBtn" class="btn" data-i18n="common.load">Charger</button>
          </div>
          <span style="flex:1 1 100%; height:0;"></span>
          <button id="lbcReset" class="btn" data-i18n="common.reset">Réinitialiser</button>
          <button id="lbcSave" class="btn primary" data-i18n="common.load">Charger</button>
        </div>
      </div>
    </div>

    <!-- EMA/MA modal -->
    <div id="emaModal" class="modal hidden" aria-hidden="true" role="dialog">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h2 data-i18n="ema.modal.title">EMA / MA</h2>
          <button id="emaClose" class="icon-btn" aria-label="Fermer">×</button>
        </div>
        <div class="modal-body">
          <form class="form-grid">
            <fieldset>
              <legend>EMA</legend>
              <label><input id="ema21En" type="checkbox" checked /> EMA <input id="ema21Len" type="number" value="21" style="width:5rem" /> <input id="ema21Col" type="color" value="#facc15" /></label>
              <label><input id="ema34En" type="checkbox" checked /> EMA <input id="ema34Len" type="number" value="34" style="width:5rem" /> <input id="ema34Col" type="color" value="#ffa500" /></label>
              <label><input id="ema55En" type="checkbox" checked /> EMA <input id="ema55Len" type="number" value="55" style="width:5rem" /> <input id="ema55Col" type="color" value="#ef4444" /></label>
              <label><input id="ema200En" type="checkbox" checked /> EMA <input id="ema200Len" type="number" value="200" style="width:5rem" /> <input id="ema200Col" type="color" value="#000000" /></label>
            </fieldset>
            <fieldset>
              <legend>MA</legend>
              <label><input id="ma5En" type="checkbox" checked /> MA <input id="ma5Len" type="number" value="5" style="width:5rem" /> <input id="ma5Col" type="color" value="#3b82f6" /></label>
              <label><input id="ma8En" type="checkbox" checked /> MA <input id="ma8Len" type="number" value="8" style="width:5rem" /> <input id="ma8Col" type="color" value="#00ffff" /></label>
              <label><input id="ma13En" type="checkbox" checked /> MA <input id="ma13Len" type="number" value="13" style="width:5rem" /> <input id="ma13Col" type="color" value="#22c55e" /></label>
            </fieldset>
          </form>
        </div>
        <div class="modal-footer">
          <button id="emaSave" class="btn primary" data-i18n="common.save">Enregistrer</button>
        </div>
      </div>
    </div>

    <!-- Backtest progress modal -->
    <div id="btProgress" class="modal hidden" aria-hidden="true" role="dialog">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-content small">
        <div class="modal-header">
          <h2 data-i18n="bt.progress.title">Simulation</h2>
        </div>
        <div class="modal-body">
          <div id="btProgText" style="margin-bottom:6px;" data-i18n="bt.progress.initShort">Préparation...</div>
          <div class="progress"><div id="btProgBar"></div></div>
          <div id="btProgTime" style="margin-top:6px; font-size:12px;">⏱ 00:00</div>
          <div id="btProgNote" style="margin-top:4px; color:var(--muted); font-size:12px;"></div>
          <div id="btProgGlobalText" style="margin-top:8px; font-size:12px;" data-i18n="bt.progress.globalInit">Global: 0% (0/0) — ETA —</div>
          <div class="progress"><div id="btProgGlobalBar"></div></div>
          <pre id="btProgLog" style="margin-top:6px; max-height:35vh; overflow:auto; background:var(--bg2, rgba(0,0,0,0.04)); padding:6px; border-radius:4px; font-size:12px; white-space:pre-wrap;">—</pre>
        </div>
        <div class="modal-footer">
          <div style="margin-right:auto; display:flex; gap:8px;">
            <button id="btPause" class="btn" title="Mettre en pause/Reprendre" data-i18n="bt.progress.btn.pause" data-i18n-title="bt.progress.pauseTitle">Pause</button>
            <button id="btStop" class="btn" title="Arrêter" data-i18n="bt.progress.btn.stop" data-i18n-title="bt.progress.stopTitle">Stop</button>
          </div>
          <button id="btShowDetails" class="btn" title="Afficher la liste complète des évaluations" data-i18n="bt.progress.btn.details" data-i18n-title="bt.progress.detailsTitle">Détails</button>
          <button id="btExportDetails" class="btn" title="Exporter les évaluations en CSV" data-i18n="bt.progress.btn.export" data-i18n-title="bt.progress.exportTitle">Exporter CSV</button>
          <button id="btAbort" class="btn" data-i18n="bt.progress.btn.cancel">Annuler</button>
        </div>
      </div>
    </div>

    <!-- Backtest settings modal -->
    <div id="btModal" class="modal hidden" aria-hidden="true" role="dialog">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h2 data-i18n="bt.modal.title">Paramètres de simulation</h2>
          <button id="btCloseModal" class="icon-btn" aria-label="Fermer">×</button>
        </div>
        <div class="modal-body">
          <form id="btForm" class="form-grid">
            <fieldset>
              <legend data-i18n="bt.modal.general.legend">G e9n e9ral</legend>
              <label><span data-i18n="bt.modal.startCap">Capital initial</span> <input id="btStartCap" type="number" min="0" step="100" value="10000" style="width:8rem" /></label>
              <label><span data-i18n="bt.modal.fee">Frais (%)</span> <input id="btFee" type="number" min="0" step="0.01" value="0.10" style="width:6rem" /></label>
              <label><span data-i18n="bt.modal.lev">Levier (x)</span> <input id="btLev" type="number" min="1" max="125" step="0.1" value="1" style="width:6rem" /></label>
              <label><span data-i18n="bt.modal.maxPct">Max % par trade</span> <input id="btMaxPct" type="number" min="0" max="100" step="1" value="100" style="width:6rem" /></label>
              <label><span data-i18n="bt.modal.baseCap">Base du capital</span>
                <select id="btMaxBase">
                  <option value="initial" selected data-i18n="bt.modal.base.initial">Capital initial</option>
                  <option value="equity" data-i18n="bt.modal.base.equity">Capital variable</option>
                </select>
              </label>
            </fieldset>
            <fieldset>
              <legend data-i18n="bt.modal.period.legend">P e9riode</legend>
              <label><input type="radio" name="btRangeMode" id="btRangeVisible" value="visible" checked /> <span data-i18n="bt.modal.range.visible">P e9riode visible</span></label>
              <label><input type="radio" name="btRangeMode" id="btRangeAll" value="all" /> <span data-i18n="bt.modal.range.all">Tout l'historique</span></label>
              <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                <label><input type="radio" name="btRangeMode" id="btRangeDates" value="dates" /> <span data-i18n="bt.modal.range.dates">Dates</span></label>
                <label><span data-i18n="bt.modal.range.from">De</span> <input id="btFrom" type="datetime-local" style="width: 14rem" /></label>
                <label><span data-i18n="bt.modal.range.to"> c0</span> <input id="btTo" type="datetime-local" style="width: 14rem" /></label>
              </div>
              <p style="color:var(--muted);font-size:12px;margin:4px 0 0;" data-i18n="bt.modal.range.note">Les dates sont interpr e9t e9es dans votre fuseau horaire local.</p>
            </fieldset>
            <fieldset style="display:none">
              <legend data-i18n="bt.modal.opt.legend">Optimisation (utiliser le Lab)</legend>
              <p style="color:var(--muted);font-size:12px;margin:0 0 6px;" data-i18n="bt.modal.opt.note">Optimise sur l'intervalle actuel (s e9lectionne 1m/5m/15m en haut).</p>
              <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
                <label><span data-i18n="bt.modal.opt.strategy">Strat e9gie</span>
                    <select id="btOptStrategy">
                      <option value="grid" selected data-i18n="bt.modal.opt.strategy.grid">Grille</option>
                      <option value="random" data-i18n="bt.modal.opt.strategy.random">Al e9atoire</option>
                      <option value="ea" data-i18n="bt.modal.opt.strategy.ea"> c9volutionnaire</option>
                      <option value="bayes" data-i18n="bt.modal.opt.strategy.bayes">Bayes (EDA)</option>
                    </select>
                </label>
                <label><span data-i18n="bt.modal.opt.tf">TF</span>
                  <select id="btOptInterval" style="min-width:6rem;">
                    <option value="1m">1m</option>
                    <option value="5m">5m</option>
                    <option value="15m">15m</option>
                    <option value="1h">1h</option>
                    <option value="4h">4h</option>
                    <option value="1d">1d</option>
                  </select>
                </label>
                <label><span data-i18n="bt.modal.opt.profile">Profil</span>
                  <select id="btOptProfile" style="min-width:8rem;">
                    <option value="sure" data-i18n="bt.modal.opt.profile.safe">S bre</option>
                    <option value="balancee" selected data-i18n="bt.modal.opt.profile.bal">Balanc e9e</option>
                    <option value="agressive" data-i18n="bt.modal.opt.profile.agg">Agressive</option>
                  </select>
                </label>
                <label><span data-i18n="bt.modal.opt.maxComb">Max combinaisons</span> <input id="btOptMax" type="number" min="1" max="10000" step="1" value="100" style="width:6rem" /></label>
                <label><span data-i18n="bt.modal.opt.topN">Top N</span> <input id="btOptTopN" type="number" min="1" max="1000" step="1" value="20" style="width:6rem" /></label>
              </div>
              <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
                <span data-i18n="bt.modal.opt.modesLabel">Modes d'entr e9e:</span>
                <label><input id="btOptEMOrig" type="checkbox" /> <span data-i18n="bt.modal.opt.mode.original">Original</span></label>
                <label><input id="btOptEMFib" type="checkbox" /> <span data-i18n="bt.modal.opt.mode.fib">Fib Retracement</span></label>
                <label><input id="btOptEMBoth" type="checkbox" checked /> <span data-i18n="bt.modal.opt.mode.both">Both</span></label>
                <span style="flex:1 1 auto"></span>
                <label data-i18n-title="bt.modal.opt.usePriorTitle"><input id="btUseTFPrior" type="checkbox" /> <span data-i18n="bt.modal.opt.usePrior">Prior TF</span></label>
              </div>
              <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px;">
                <div>
                  <label><input id="btOptNolEn" type="checkbox" checked /> <span data-i18n="bt.modal.opt.nolEn">NOL</span></label>
                  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                    <label><span data-i18n="bt.modal.opt.min">Min</span> <input id="btOptNolMin" type="number" min="1" value="2" style="width:5rem" /></label>
                    <label><span data-i18n="bt.modal.opt.max">Max</span> <input id="btOptNolMax" type="number" min="1" value="5" style="width:5rem" /></label>
                    <label><span data-i18n="bt.modal.opt.step">Pas</span> <input id="btOptNolStep" type="number" min="1" value="1" style="width:5rem" /></label>
                  </div>
                </div>
                <div>
                  <label><input id="btOptPrdEn" type="checkbox" checked /> <span data-i18n="bt.modal.opt.prdEn">P e9riode (prd)</span></label>
                  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                    <label><span data-i18n="bt.modal.opt.min">Min</span> <input id="btOptPrdMin" type="number" min="2" value="8" style="width:5rem" /></label>
                    <label><span data-i18n="bt.modal.opt.max">Max</span> <input id="btOptPrdMax" type="number" min="2" value="34" style="width:5rem" /></label>
                    <label><span data-i18n="bt.modal.opt.step">Pas</span> <input id="btOptPrdStep" type="number" min="1" value="2" style="width:5rem" /></label>
                  </div>
                </div>
                <div>
                  <label><input id="btOptSLEn" type="checkbox" checked /> <span data-i18n="bt.modal.opt.slEn">SL initial %</span></label>
                  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                    <label><span data-i18n="bt.modal.opt.min">Min</span> <input id="btOptSLMin" type="number" min="0" step="0.1" value="0.5" style="width:5rem" /></label>
                    <label><span data-i18n="bt.modal.opt.max">Max</span> <input id="btOptSLMax" type="number" min="0" step="0.1" value="3.0" style="width:5rem" /></label>
                    <label><span data-i18n="bt.modal.opt.step">Pas</span> <input id="btOptSLStep" type="number" min="0.1" step="0.1" value="0.5" style="width:5rem" /></label>
                  </div>
                </div>
                <div>
                  <label><input id="btOptBEBarsEn" type="checkbox" checked /> <span data-i18n="bt.modal.opt.beBarsEn">Bars to BE</span></label>
                  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                    <label><span data-i18n="bt.modal.opt.min">Min</span> <input id="btOptBEBarsMin" type="number" min="1" value="3" style="width:5rem" /></label>
                    <label><span data-i18n="bt.modal.opt.max">Max</span> <input id="btOptBEBarsMax" type="number" min="1" value="8" style="width:5rem" /></label>
                    <label><span data-i18n="bt.modal.opt.step">Pas</span> <input id="btOptBEBarsStep" type="number" min="1" value="1" style="width:5rem" /></label>
                  </div>
                </div>
                <div>
                  <label><input id="btOptBELockEn" type="checkbox" checked /> <span data-i18n="bt.modal.opt.beLockEn">Lock % move</span></label>
                  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                    <label><span data-i18n="bt.modal.opt.min">Min</span> <input id="btOptBELockMin" type="number" min="0" step="0.1" value="3" style="width:5rem" /></label>
                    <label><span data-i18n="bt.modal.opt.max">Max</span> <input id="btOptBELockMax" type="number" min="0" step="0.1" value="10" style="width:5rem" /></label>
                    <label><span data-i18n="bt.modal.opt.step">Pas</span> <input id="btOptBELockStep" type="number" min="0.1" step="0.1" value="1" style="width:5rem" /></label>
                  </div>
                </div>
                <div>
                  <label><input id="btOptEMALenEn" type="checkbox" checked /> <span data-i18n="bt.modal.opt.emaLenEn">EMA len</span></label>
                  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                    <label><span data-i18n="bt.modal.opt.min">Min</span> <input id="btOptEMALenMin" type="number" min="1" value="21" style="width:5rem" /></label>
                    <label><span data-i18n="bt.modal.opt.max">Max</span> <input id="btOptEMALenMax" type="number" min="1" value="89" style="width:5rem" /></label>
                    <label><span data-i18n="bt.modal.opt.step">Pas</span> <input id="btOptEMALenStep" type="number" min="1" value="4" style="width:5rem" /></label>
                  </div>
                </div>
                <!-- EA params -->
                <div>
                  <label><span data-i18n="bt.modal.opt.ea.pop">EA: Pop</span> <input id="btEAPop" type="number" min="4" max="2000" value="40" style="width:6rem" /></label>
                  <label><span data-i18n="bt.modal.opt.ea.gens">Gens</span> <input id="btEAGen" type="number" min="1" max="500" value="20" style="width:6rem" /></label>
                  <label><span data-i18n="bt.modal.opt.ea.mut">Mut %</span> <input id="btEAMut" type="number" min="0" max="100" step="1" value="20" style="width:6rem" /></label>
                  <label><span data-i18n="bt.modal.opt.ea.cx">Cx %</span> <input id="btEACx" type="number" min="0" max="100" step="1" value="60" style="width:6rem" /></label>
                  <label><input id="btEAResume" type="checkbox" /> <span data-i18n="bt.modal.opt.ea.resume">Resume</span></label>
                </div>
                <!-- Bayes(EDA) params -->
                <div>
                  <label><span data-i18n="bt.modal.opt.bayes.iters">Bayes: Iters</span> <input id="btBayIters" type="number" min="10" max="5000" value="150" style="width:6rem" /></label>
                  <label><span data-i18n="bt.modal.opt.bayes.init">Init random</span> <input id="btBayInit" type="number" min="5" max="2000" value="40" style="width:8rem" /></label>
                  <label><span data-i18n="bt.modal.opt.bayes.elite">Elite %</span> <input id="btBayElitePct" type="number" min="5" max="80" step="1" value="30" style="width:6rem" /></label>
                  <label><input id="btBayResume" type="checkbox" /> <span data-i18n="bt.modal.opt.bayes.resume">Resume</span></label>
                </div>
              </div>
              <div style="margin-top:10px; border-top:1px solid var(--header-border); padding-top:10px;">
                <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
                  <label><input id="btOptTPEn" type="checkbox" /> <span data-i18n="bt.modal.opt.tpFibEn">Optimiser TP (Fib)</span></label>
                  <label><span data-i18n="bt.modal.opt.tpCount">Nb TP</span> <input id="btOptTPCount" type="number" min="1" max="10" value="3" style="width:5rem" /></label>
                  <span style="color:var(--muted);font-size:12px;" data-i18n="bt.modal.opt.tpFibNote">Les ratios s e9lectionn e9s seront affect e9s aux TP1..TPn (ordre croissant)</span>
                </div>
                <div id="btOptTPFibWrap" style="display:flex; gap:10px; flex-wrap:wrap;">
                  <label><input type="checkbox" data-r="0.236" checked />0.236</label>
                  <label><input type="checkbox" data-r="0.382" checked />0.382</label>
                  <label><input type="checkbox" data-r="0.5" checked />0.500</label>
                  <label><input type="checkbox" data-r="0.618" checked />0.618</label>
                  <label><input type="checkbox" data-r="0.786" />0.786</label>
                  <label><input type="checkbox" data-r="1" checked />1.000</label>
                  <label><input type="checkbox" data-r="1.272" />1.272</label>
                  <label><input type="checkbox" data-r="1.414" />1.414</label>
                  <label><input type="checkbox" data-r="1.618" checked />1.618</label>
                  <label><input type="checkbox" data-r="2" />2.000</label>
                  <label><input type="checkbox" data-r="2.618" />2.618</label>
                  <label><input type="checkbox" data-r="3" />3.000</label>
                </div>
              </div>
              <div style="margin-top:10px; border-top:1px solid var(--header-border); padding-top:10px;">
                <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
                  <label><input id="btOptTPPctEn" type="checkbox" /> <span data-i18n="bt.modal.opt.tpPctEn">Optimiser TP (Percent)</span></label>
                  <label><span data-i18n="bt.modal.opt.tpCount">Nb TP</span> <input id="btOptTPPctCount" type="number" min="1" max="10" value="3" style="width:5rem" /></label>
                  <label><span data-i18n="bt.modal.opt.tpMinPct">Min %</span> <input id="btOptTPPctMin" type="number" min="0" step="0.1" value="0.5" style="width:5rem" /></label>
                  <label><span data-i18n="bt.modal.opt.tpMaxPct">Max %</span> <input id="btOptTPPctMax" type="number" min="0" step="0.1" value="5.0" style="width:5rem" /></label>
                  <label><span data-i18n="bt.modal.opt.tpStepPct">Pas %</span> <input id="btOptTPPctStep" type="number" min="0.1" step="0.1" value="0.5" style="width:5rem" /></label>
                </div>
              </div>
              <div style="margin-top:10px; border-top:1px solid var(--header-border); padding-top:10px;">
                <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
                  <label><input id="btOptAllocEn" type="checkbox" /> <span data-i18n="bt.modal.opt.allocEn">Optimiser r e9partition (%)</span></label>
                  <label><span data-i18n="bt.modal.opt.allocStep">Pas</span> <input id="btOptAllocStep" type="number" min="1" max="50" step="1" value="5" style="width:5rem" /></label>
                  <label><span data-i18n="bt.modal.opt.allocMaxPat">Max patterns</span> <input id="btOptAllocMax" type="number" min="1" max="100" step="1" value="8" style="width:7rem" /></label>
                </div>
              </div>
            </fieldset>
          </form>
        </div>
        <div class="modal-footer">
          <button id="btCancel" class="btn" data-i18n="bt.modal.btn.cancel">Annuler</button>
          <button id="btOptimize" class="btn" data-i18n="bt.modal.btn.optimize">Optimiser</button>
          <button id="btRun" class="btn primary" data-i18n="bt.modal.btn.run">Lancer</button>
        </div>
      </div>
    </div>

    <!-- Live trading modal -->
    <div id="liveModal" class="modal hidden" aria-hidden="true" role="dialog">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-content" style="max-width:680px;">
        <div class="modal-header">
          <h2 data-i18n="live.modal.title">Live</h2>
          <button id="liveClose" class="icon-btn" aria-label="Fermer">×</button>
        </div>
        <div class="modal-body">
          <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 10px;">
            <fieldset>
              <legend data-i18n="live.mode.legend">Mode</legend>
              <label><input type="radio" name="liveMode" id="liveModePaper" value="paper" checked> <span data-i18n="live.mode.paper">Paper trading</span></label>
              <label title="Bientôt"><input type="radio" name="liveMode" id="liveModeReal" value="real" disabled> <span data-i18n="live.mode.real">Live trading</span></label>
            </fieldset>
            <fieldset>
              <legend data-i18n="live.wallet.legend">Wallet</legend>
              <label><span data-i18n="live.wallet.label">Portefeuille</span>
                <select id="liveWalletSel">
                  <option value="__new__" selected data-i18n="live.wallet.newOption">+ Nouveau portefeuille…</option>
                </select>
              </label>
              <label><span data-i18n="live.wallet.nameLabel">Nom</span> <input id="liveWalletName" type="text" placeholder="Ex: Strat EMA55" /></label>
              <div style="display:flex; gap:6px; flex-wrap:wrap;">
                <button id="liveWalletSave" class="btn" type="button" data-i18n="common.save">Enregistrer</button>
                <button id="liveWalletLoad" class="btn" type="button" data-i18n="common.load">Charger</button>
                <button id="liveWalletDelete" class="btn" type="button" data-i18n="common.delete">Supprimer</button>
              </div>
            </fieldset>
            <fieldset>
              <legend data-i18n="live.params.legend">Paramètres (paper)</legend>
              <label><span data-i18n="live.params.startCap">Capital initial</span> <input id="liveStartCap" type="number" min="0" step="100" value="10000" style="width:8rem" /></label>
              <label><span data-i18n="live.params.fee">Frais (%)</span> <input id="liveFee" type="number" min="0" step="0.01" value="0.10" style="width:6rem" /></label>
              <label><span data-i18n="live.params.lev">Levier (x)</span> <input id="liveLev" type="number" min="1" max="125" step="0.1" value="1" style="width:6rem" /></label>
            </fieldset>
            <fieldset>
              <legend data-i18n="live.tf.legend">TF & Stratégie</legend>
              <label><span data-i18n="live.tf.label">TF</span>
                <select id="liveTFSelect"></select>
              </label>
              <div style="display:flex; gap:8px; align-items:center;">
                <label><input type="radio" name="liveStratSource" id="liveStratSrcHeaven" value="heaven" checked> <span data-i18n="live.tf.source.heaven">Heaven</span></label>
                <label><input type="radio" name="liveStratSource" id="liveStratSrcPalmares" value="palmares"> <span data-i18n="live.tf.source.palmares">Palmarès</span></label>
              </div>
              <label><span data-i18n="live.tf.strategyLabel">Stratégie</span>
                <select id="liveStrategySel">
                  <option value="">—</option>
                </select>
              </label>
              <div id="liveStrategyMeta" style="color:var(--muted); font-size:12px;">—</div>
            </fieldset>
          </div>
        </div>
        <div class="modal-footer" style="display:flex; gap:8px; justify-content:flex-end;">
          <button id="liveStop" class="btn" data-i18n="live.footer.stop">Arrêter</button>
          <button id="liveStart" class="btn primary" data-i18n="live.footer.start">Lancer</button>
        </div>
      </div>
    </div>

    <!-- Strategy details modal -->
    <div id="stratModal" class="modal hidden" aria-hidden="true" role="dialog">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-content small" style="max-width:720px;">
        <div class="modal-header">
          <h2 data-i18n="strat.modal.title">Détails stratégie</h2>
          <div style="display:flex; gap:6px; align-items:center;">
            <button id="stratCollapse" class="icon-btn" title="Replier">▾</button>
            <button id="stratClose" class="icon-btn" aria-label="Fermer">×</button>
          </div>
        </div>
        <div class="modal-body">
          <div id="stratTitle" style="margin-bottom:8px; color:var(--muted);"></div>
          <table class="lbc-table" style="width:100%; table-layout:auto; font-size:12px;">
            <thead>
              <tr>
                <th style="text-align:left;" data-i18n="strat.table.crit">Critère</th>
                <th data-i18n="strat.table.score">Note / 100</th>
                <th style="text-align:right;" data-i18n="strat.table.value">Valeur</th>
              </tr>
            </thead>
            <tbody id="stratTBody"><tr><td colspan="3">—</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Trades details modal -->
    <div id="tradesModal" class="modal hidden" aria-hidden="true" role="dialog">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-content" style="max-width:920px;">
        <div class="modal-header">
          <h2 data-i18n="trades.modal.title">Historique des trades</h2>
          <span id="tradesHdrCtx" style="margin-left:auto; color:var(--muted); font-size:12px;"></span>
          <div style="display:flex; gap:6px; align-items:center;">
            <button id="tradesCollapse" class="icon-btn" title="Replier">▾</button>
            <button id="tradesClose" class="icon-btn" aria-label="Fermer">×</button>
          </div>
        </div>
        <div class="modal-body">
          <div id="tradesCtx" style="margin-bottom:8px; color:var(--muted);"></div>
          <div style="overflow:auto; max-height:60vh;">
            <table class="lbc-table" style="width:100%; table-layout:auto; font-size:12px;">
              <thead>
                <tr>
                  <th>#</th>
                  <th data-i18n="trades.table.time">Horaire</th>
                  <th data-i18n="trades.table.equity">Capital</th>
                  <th data-i18n="trades.table.trade">Trade</th>
                  <th data-i18n="trades.table.qty">Quantité</th>
                  <th data-i18n="trades.table.entry">Prix entrée</th>
                  <th data-i18n="trades.table.exit">Prix sortie</th>
                  <th data-i18n="trades.table.fee">Frais</th>
                  <th data-i18n="trades.table.pnl">P&L</th>
                  <th data-i18n="trades.table.duration">Durée</th>
                </tr>
              </thead>
              <tbody id="tradesTBody"><tr><td colspan="11">—</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Weights modal -->
    <div id="weightsModal" class="modal hidden" aria-hidden="true" role="dialog">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-content" style="max-width:720px;">
        <div class="modal-header">
          <h2 data-i18n="lab.weights.modalTitle">Pondérations — Score global</h2>
          <button id="weightsClose" class="icon-btn" aria-label="Fermer">×</button>
        </div>
        <div class="modal-body">
          <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px; flex-wrap:wrap; justify-content:space-between;">
            <label>
              <span data-i18n="lab.weights.profileLabel">Profil</span>
              <select id="weightsProfile">
                <option value="sure" data-i18n="lab.weights.profile.safe">Sûre</option>
                <option value="balancee" selected data-i18n="lab.weights.profile.bal">Balancée</option>
                <option value="agressive" data-i18n="lab.weights.profile.agg">Agressive</option>
              </select>
            </label>
            <div style="display:flex; gap:8px; align-items:center; font-size:12px; color:var(--muted);">
              <span data-i18n="lab.weights.totalHint">Les poids doivent totaliser 100%.</span>
              <span id="weightsTotalInfo">Total: 100 pts • Reste: 0 pts</span>
            </div>
          </div>
          <div id="weightsBody"></div>
          <div id="weightsInfoText" style="margin-top:8px; font-size:12px; color:var(--muted);" data-i18n="lab.weights.infoDefault">
            Cliquez sur le (i) d’un facteur pour voir à quoi il sert et comment intervient son poids dans le score.
          </div>
        </div>
        <div class="modal-footer">
          <button id="weightsSave" class="btn primary" data-i18n="lab.weights.save">Enregistrer</button>
        </div>
      </div>
    </div>


    <!-- Strategy detail modal -->
    <div id="detailModal" class="modal hidden" aria-hidden="true" role="dialog">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-content" style="max-width:1000px;">
        <div class="modal-header">
          <h2 data-i18n="detail.title">Analyse stratégie</h2>
          <button id="detailClose" class="icon-btn" aria-label="Fermer">×</button>
        </div>
        <div class="modal-body">
          <div id="detailCtx" style="margin-bottom:8px; color:var(--muted);"></div>
          <div id="detailConfBar" style="margin-bottom:8px; display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
            <label data-i18n="detail.conf.capital">Capital initial
              <input id="detailStartCap" type="number" min="0" step="100" style="width:8rem;" />
            </label>
            <label data-i18n="detail.conf.fee">Frais (%)
              <input id="detailFee" type="number" min="0" step="0.01" style="width:6rem;" />
            </label>
            <label data-i18n="detail.conf.lev">Levier (x)
              <input id="detailLev" type="number" min="1" max="125" step="0.1" style="width:6rem;" />
            </label>
            <button id="detailConfApply" class="btn" data-i18n="detail.conf.apply">Appliquer</button>
            <span style="color:var(--muted); font-size:12px;" data-i18n="detail.conf.note">Ces paramètres n'affectent que cette analyse détaillée.</span>
          </div>
          <!-- Barre de configuration de la stratégie de comparaison -->
          <div id="detailCompareBar" style="margin-bottom:8px; display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
            <label data-i18n="detail.compare.label">Comparer à
              <select id="detailCompSource" style="min-width:12rem;">
                <option value="heaven" selected data-i18n="detail.compare.source.heaven">Heaven (config actuelle)</option>
                <option value="palmares" data-i18n="detail.compare.source.palmares">Palmarès</option>
              </select>
            </label>
            <label data-i18n="detail.compare.pair">Pair
              <select id="detailCompSymbol" style="min-width:9rem;"></select>
            </label>
            <label data-i18n="detail.compare.tf">TF
              <select id="detailCompTF" style="min-width:6rem;">
                <option value="1m">1m</option>
                <option value="5m">5m</option>
                <option value="15m">15m</option>
                <option value="1h">1h</option>
                <option value="4h">4h</option>
                <option value="1d">1d</option>
              </select>
            </label>
            <label data-i18n="detail.compare.profile">Profil
              <select id="detailCompProfile" style="min-width:10rem;">
                <option value="sure" data-i18n="lab.weights.profile.safe">Stratégie sûre</option>
                <option value="balancee" selected data-i18n="lab.weights.profile.bal">Stratégie balancée</option>
                <option value="agressive" data-i18n="lab.weights.profile.agg">Stratégie agressive</option>
              </select>
            </label>
            <label data-i18n="detail.compare.strategy">Stratégie
              <select id="detailCompPalmares" style="min-width:14rem;">
                <option value="">—</option>
              </select>
            </label>
            <button id="detailCompApply" class="btn" data-i18n="detail.compare.apply">Appliquer</button>
          </div>
          <div id="detailTradesBar" style="margin-bottom:8px; display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
            <button id="detailTradesMainBtn" class="btn">Trades stratégie</button>
            <button id="detailTradesCmpBtn" class="btn">Trades comparaison</button>
            <span style="color:var(--muted); font-size:12px;">Liste détaillée des trades (TP / SL / BE) comme dans le backtest.</span>
          </div>
          <div style="display:grid; grid-template-columns: 1fr; gap:12px;">
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.radar.title">Radar critères</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.radar.desc">Vue synthétique des principaux critères (0–100). Permet de repérer d'un coup d'œil les forces et faiblesses globales de la stratégie.</div>
              <canvas id="detailRadar" width="980" height="300" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailRadarNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.eq.title">Équity</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.eq.desc">Évolution du capital dans le temps. Cherchez une courbe régulière avec des phases de baisse limitées et un profil compatible avec votre tolérance au risque.</div>
              <canvas id="detailEquity" width="980" height="220" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailEquityNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
              <div id="detailCompareNote" style="color:var(--muted); font-size:12px; margin-top:2px;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.dd.title">Drawdown absolu</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.dd.desc">Taille des creux en dollars. Permet d'identifier les pires périodes de pertes et de vérifier qu'elles restent acceptables pour le capital engagé.</div>
              <canvas id="detailDD" width="980" height="100" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailDDNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.under.title">Underwater (drawdown %)</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.under.desc">Drawdown en pourcentage du capital. Utile pour comparer le risque relatif entre stratégies ou paramètres sur des capitaux différents.</div>
              <canvas id="detailUnder" width="980" height="120" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailUnderNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.hist.title">Distribution des rendements</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.hist.desc">Histogramme des retours par trade. Recherchez une queue de pertes limitée et une queue de gains étendue, signe d'un bon équilibre risque/rendement.</div>
              <canvas id="detailHist" width="980" height="180" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailHistNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.eff.title">Efficacité de la stratégie</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.eff.desc">Barres normalisées (Win%, R:R, efficacité, temps en marché, fréquence). Permet de voir en un clin d'œil les composantes fortes et celles à optimiser.</div>
              <canvas id="detailEff" width="980" height="180" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailEffNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.robust.title">Complexité & Robustesse</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.robust.desc">Mesure le compromis entre nombre de paramètres actifs et robustesse globale. Idéalement, viser une robustesse élevée avec une complexité raisonnable.</div>
              <canvas id="detailRobust" width="980" height="160" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailRobustNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
            <div id="detailSummary" style="padding:8px; border:1px solid var(--header-border); border-radius:8px; background:var(--bg);">
              <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:6px;">
                <div>
                  <div style="font-weight:600;" data-i18n="detail.section.summary.title">Commentaire & analyse</div>
                  <div style="color:var(--muted); font-size:11px;" data-i18n="detail.section.summary.desc">Synthèse narrative de la stratégie et de sa comparée. À lire pour comprendre le profil de risque/rendement, les axes d'amélioration, et l'impact du slippage réel sur la performance.</div>
                </div>
                <div style="display:flex; gap:6px; align-items:center; font-size:12px;">
                  <label data-i18n="detail.slip.label">Slippage (bps)
                    <input id="detailSlipBps" type="number" min="0" max="200" step="1" value="0" style="width:6rem;" />
                  </label>
                  <button id="detailSlipApply" class="btn" data-i18n="detail.slip.apply">Appliquer</button>
                  <button id="detailSlipInfo" class="icon-btn" type="button" aria-label="Infos slippage" title="Infos slippage" data-i18n-aria-label="detail.slip.infoTitle" data-i18n-title="detail.slip.infoTitle">?</button>
                  <span id="detailSlipNote" style="color:var(--muted);"></span>
                </div>
              </div>
              <div id="detailSummaryBody" style="color:var(--muted); white-space:pre-wrap;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.ci.title">IC (bootstrap 95%)</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.ci.desc">Intervalles de confiance estimés par bootstrap. Permettent de visualiser l'incertitude sur Win%, PF et expectancy plutôt que de se fier à un seul chiffre.</div>
              <canvas id="detailCIs" width="980" height="140" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailCIsNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.rollpf.title">Rolling PF (fenêtre 30)</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.rollpf.desc">Profit factor calculé sur une fenêtre glissante. Sert à détecter les phases où la stratégie passe durablement sous PF&nbsp;1 (non rentable).</div>
              <canvas id="detailRollPF" width="980" height="140" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailRollPFNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.rollwin.title">Rolling Win% (fenêtre 30)</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.rollwin.desc">Taux de réussite glissant. Met en évidence les périodes où la stratégie décroche ou s'améliore fortement.</div>
              <canvas id="detailRollWin" width="980" height="140" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailRollWinNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.rollrr.title">Rolling Avg R:R (fenêtre 30)</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.rollrr.desc">R:R moyen sur 30 positions. Permet de voir si les objectifs deviennent trop courts ou trop ambitieux dans certains régimes.</div>
              <canvas id="detailRollRR" width="980" height="140" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailRollRRNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.rollexp.title">Rolling Expectancy (fenêtre 30)</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.rollexp.desc">Expectancy par trade sur fenêtre glissante. À utiliser pour repérer les zones temporelles où la stratégie devient négative.</div>
              <canvas id="detailRollExp" width="980" height="140" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailRollExpNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.dur.title">Durée des trades</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.dur.desc">Répartition de la durée des positions. Vérifiez que la stratégie correspond bien à votre horizon de temps (scalping, swing, positionnel...).</div>
              <canvas id="detailDurHist" width="980" height="140" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailDurHistNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.streaks.title">Séquences victoires/défaites</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.streaks.desc">Distribution des séries de gains et de pertes. Met en lumière la possibilité de longues séries perdantes à supporter psychologiquement.</div>
              <canvas id="detailStreaks" width="980" height="140" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailStreaksNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.ls.title">Distribution retours — Long vs Short</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.ls.desc">Compare la distribution des performances Long et Short. Idéal pour voir si un côté du marché porte l'essentiel de la performance.</div>
              <canvas id="detailLSHist" width="980" height="160" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailLSHistNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.mae.title">MAE/MFE (excursions en R)</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.mae.desc">Dispersion des excursions maximales en R (risque). Sert à calibrer TP/SL et trailing en fonction de ce que le marché offre réellement.</div>
              <canvas id="detailMAEMFE" width="980" height="220" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailMAEMFENote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.weekly.title">Saisonnalité — Retours hebdomadaires (%)</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.weekly.desc">Carte des retours semaine par semaine. À utiliser pour repérer les périodes structurellement favorables ou défavorables à la stratégie.</div>
              <canvas id="detailWeekly" width="980" height="220" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailWeeklyNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.dow.title">Saisonnalité — par jour de semaine (%)</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.dow.desc">Retour moyen par jour de la semaine. Sert à filtrer d'éventuels jours structurellement faibles ou instables.</div>
              <canvas id="detailDOW" width="980" height="200" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailDOWNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.dowHour.title">Saisonnalité — Jour × Heure (retours %)</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.dowHour.desc">Heatmap jour × heure. Idéale pour identifier les créneaux horaires où la stratégie surperforme ou sous-performe.</div>
              <canvas id="detailDOWHour" width="980" height="220" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailDOWHourNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.dowHourLong.title">Jour × Heure — Long seulement</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.dowHourLong.desc">Même carte jour × heure mais filtrée sur les positions Long. Permet de voir où la jambe acheteuse est réellement efficace.</div>
              <canvas id="detailDOWHourLong" width="980" height="200" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailDOWHourLongNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.dowHourShort.title">Jour × Heure — Short seulement</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.dowHourShort.desc">Idem pour les positions Short. Utile pour voir si la jambe vendeuse est opportuniste ou trop fragile sur certains créneaux.</div>
              <canvas id="detailDOWHourShort" width="980" height="200" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailDOWHourShortNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.wf.title">Walk-forward — splits temporels</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.wf.desc">Performance par segment temporel. Sert à vérifier que la stratégie reste exploitable hors échantillon et ne dépend pas d'une seule période.</div>
              <canvas id="detailWF" width="980" height="200" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailWFNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.regime.title">Régimes (Trend × Volatilité)</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.regime.desc">PF par combinaison de tendance et de volatilité. Identifie clairement les régimes de marché où la stratégie fonctionne bien ou mal.</div>
              <canvas id="detailRegime" width="980" height="200" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailRegimeNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.pareto.title">Pareto — P&L vs Max DD (Palmarès)</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.pareto.desc">Nuage P&L vs drawdown. Permet de comparer visuellement le compromis rendement/risque de la stratégie par rapport au Palmarès.</div>
              <canvas id="detailPareto" width="980" height="220" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailParetoNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.mc.title">Monte Carlo — éventail d'équity (bootstrap trades)</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.mc.desc">Simulation aléatoire de l'ordre des trades. Montre la dispersion possible des trajectoires d'équity à partir du même historique de trades.</div>
              <canvas id="detailMC" width="980" height="220" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailMCNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.qq.title">QQ-Plot (retours normalisés)</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.qq.desc">Compare la distribution des rendements à une loi normale. Sert à repérer des queues épaisses ou des asymétries importantes.</div>
              <canvas id="detailQQ" width="980" height="200" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailQQNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
            <div>
              <div style="font-weight:600;" data-i18n="detail.section.acf.title">Autocorrélation (lags)</div>
              <div style="color:var(--muted); font-size:11px; margin-bottom:4px;" data-i18n="detail.section.acf.desc">Autocorrélation des rendements sur plusieurs lags. Permet de voir s'il existe un clustering de gains/pertes ou des dépendances exploitables.</div>
              <canvas id="detailACF" width="980" height="200" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div id="detailACFNote" style="color:var(--muted); font-size:12px; margin-top:4px;">—</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Evaluations detail modal -->
    <div id="evalsModal" class="modal hidden" aria-hidden="true" role="dialog">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-content" style="max-width:1000px;">
        <div class="modal-header">
          <h2 data-i18n="evals.modal.title">Détails des évaluations</h2>
          <button id="evalsClose" class="icon-btn" aria-label="Fermer">×</button>
        </div>
        <div class="modal-body">
          <div id="evalsCtx" style="margin-bottom:8px; color:var(--muted);"></div>
          <div style="overflow:auto; max-height:60vh;">
            <table class="lbc-table" style="width:100%; table-layout:auto; font-size:12px;">
              <thead>
                <tr>
                  <th>#</th><th>Score</th><th>PF</th><th>P&L</th><th>Trades</th><th>Win%</th><th>Avg RR</th><th>Params</th>
                </tr>
              </thead>
              <tbody id="evalsTBody"><tr><td colspan="8">—</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Global palmarès modal -->
    <div id="globalPalmaresModal" class="modal hidden" aria-hidden="true" role="dialog">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-content" style="max-width:1040px;">
        <div class="modal-header">
          <h2>Palmarès global</h2>
          <button id="globalPalmaresClose" class="icon-btn" aria-label="Fermer">×</button>
        </div>
        <div class="modal-body">
          <div id="globalPalSummary" style="margin-bottom:4px; color:var(--muted);"></div>
          <div class="lab-sort-controls" style="margin-bottom:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <label for="globalPalSortMode" style="display:inline-flex; align-items:center; gap:6px; font-size:13px; color:var(--muted);">
              <span>Classement</span>
              <select id="globalPalSortMode" style="padding:2px 4px; font-size:13px;">
                <option value="score">Score robuste</option>
                <option value="raw">Score brut</option>
                <option value="pnl">P&amp;L net</option>
              </select>
            </label>
          </div>
          <div style="overflow:auto; max-height:60vh; margin-top:4px;">
            <table class="lbc-table" style="width:100%">
              <thead>
                <tr>
                  <th>#</th><th>Pair</th><th>TF</th><th>Profil</th><th>Nom</th><th>Gen</th>
                  <th title="Score brut = score direct (pondérations)">Score brut</th>
                  <th title="Score robuste = moyenne de variantes (brut, jitter, splits) − pénalité de variance (≤ 5 pts)">Score robuste</th>
                  <th>P&amp;L</th><th>Cap. final</th><th>Trades</th><th>Win%</th><th>Avg RR</th><th>Max DD</th>
                </tr>
              </thead>
              <tbody id="globalPalTBody"><tr><td colspan="14">Aucune donnée</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Research / Lab modal -->
    <div id="labModal" class="modal hidden" aria-hidden="true" role="dialog">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-content lab-modal" style="max-width: 1040px;">
        <input id="labAdvEn" type="checkbox" hidden />
        <div class="modal-header">
          <h2>Lab — Recherche</h2>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <button id="labExport" class="btn">Exporter CSV</button>
            <button id="labWeights" class="btn" title="Pondérations du score">Pondérations</button>
            <label id="labAdvLabel" for="labAdvEn" class="btn" title="Mode avancé">Avancé</label>
            <button id="labClose" class="icon-btn" aria-label="Fermer">×</button>
          </div>
        </div>
        <div class="modal-body">
          <div class="form-grid lab-grid">
            <div id="labContextCard" style="display:flex; flex-direction:column; gap:8px;">
              <div class="lab-section-header">
                <div class="section-title">Objectif &amp; Contexte</div>
                <details class="param-help-inline heading lab-help-header"><summary>Aide</summary><div class="param-help">Profil ajuste les pondérations du score global (sécurité vs performance) et définit l’intention générale de la recherche. Stratégie choisit la méthode d’exploration (Hybride EA→Bayes, EA pur, ou Bayes). Pair et TF définissent la série à étudier. Plage choisit l’intervalle (Visible, Tout l’historique, Dates). Capital/Frais/Levier et Max % par trade (plafond de capital par position, 0,1–100%, Auto = algo) impactent directement les résultats (P&amp;L, PF, DD) et sont intégrés dans toutes les évaluations.</div></details>
              </div>
              <div class="lab-section-body">
                <label>Profil
                  <select id="labProfile" style="min-width:8rem;">
                    <option value="sure">Stratégie sûre</option>
                    <option value="balancee" selected>Stratégie balancée</option>
                    <option value="agressive">Stratégie agressive</option>
                  </select>
                </label>
                <label>Stratégie
                  <select id="labStrategy" style="min-width:12rem;">
                    <option value="hybrid" selected>Hybride (EA → Bayes)</option>
                    <option value="ea">Évolutionnaire (EA)</option>
                    <option value="bayes">Bayes (EDA)</option>
                  </select>
                </label>
                <label>Pair
                  <select id="labSymbolSelect" style="min-width:10rem;"></select>
                </label>
                <label>TF
                  <select id="labTFSelect" style="min-width:6rem;">
                    <option value="1m">1m</option>
                    <option value="5m">5m</option>
                    <option value="15m">15m</option>
                    <option value="1h">1h</option>
                    <option value="4h">4h</option>
                    <option value="1d">1d</option>
                  </select>
                </label>
                <label>Plage
                  <select id="labRangeMode" style="min-width:8rem;">
                    <option value="visible">Visible</option>
                    <option value="all" selected>Tout l'historique</option>
                    <option value="dates">Dates</option>
                  </select>
                </label>
                <label>De <input id="labFrom" type="datetime-local" style="width: 14rem" /></label>
                <label>À <input id="labTo" type="datetime-local" style="width: 14rem" /></label>
                <label>Capital initial <input id="labStartCap" type="number" min="0" step="100" value="10000" style="width:8rem" /></label>
                <label>Frais (%) <input id="labFee" type="number" min="0" step="0.01" value="0.10" style="width:6rem" /></label>
                <label>Levier (x) <input id="labLev" type="number" min="1" max="125" step="0.1" value="1" style="width:6rem" /></label>
                <label>Max % par trade
                  <select id="labMaxPctMode" style="min-width:8rem;">
                    <option value="auto" selected>Auto (algo)</option>
                    <option value="fixed">Fixe (%)</option>
                  </select>
                </label>
                <label>Valeur (%)
                  <input id="labMaxPct" type="number" min="0.1" max="100" step="0.1" value="100" style="width:6rem" />
                </label>
              </div>
            </div>
            <div id="labEAConfig" style="display:none; gap:8px; align-items:center; flex-wrap:wrap; grid-column:1/-1; flex-direction:column;">
              <div class="lab-section-header">
                <div class="section-title">EA</div>
                <details class="param-help-inline heading lab-help-header"><summary>Aide</summary><div class="param-help">Algorithme évolutionnaire: Pop = taille de population, Gen = nombre de générations, Mut% = taux de mutation, Cx% = taux de croisement. « Resume » continue un run précédent si disponible.</div></details>
              </div>
              <div id="labEAProfileHint" style="font-size:12px; color:var(--muted); margin:2px 0 4px;"></div>
              <div class="lab-section-body">
                <label>Pop <input id="labEAPop" type="number" min="4" max="2000" value="40" style="width:6rem" /></label>
                <label>Gen <input id="labEAGen" type="number" min="1" max="500" value="20" style="width:6rem" /></label>
                <label>Mut% <input id="labEAMut" type="number" min="0" max="100" step="1" value="20" style="width:6rem" /></label>
                <label>Cx% <input id="labEACx" type="number" min="0" max="100" step="1" value="60" style="width:6rem" /></label>
              </div>
            </div>
            <div id="labBayesConfig" style="display:none; gap:8px; align-items:center; flex-wrap:wrap; grid-column:1/-1; flex-direction:column;">
              <div class="lab-section-header">
                <div class="section-title">Bayes</div>
                <details class="param-help-inline heading lab-help-header"><summary>Aide</summary><div class="param-help">Optimisation de type Bayésienne/EDA: Iters = itérations totales, Init = points aléatoires initiaux, Elite% = proportion sélectionnée pour modéliser les prochaines propositions. « Resume » continue un run précédent si disponible.</div></details>
              </div>
              <div id="labBayesProfileHint" style="font-size:12px; color:var(--muted); margin:2px 0 4px;"></div>
              <div class="lab-section-body">
                <label>Iters <input id="labBayIters" type="number" min="10" max="5000" value="150" style="width:6rem" /></label>
                <label>Init <input id="labBayInit" type="number" min="5" max="2000" value="40" style="width:6rem" /></label>
                <label>Elite% <input id="labBayElitePct" type="number" min="5" max="80" step="1" value="30" style="width:6rem" /></label>
              </div>
            </div>
            <div id="labConstraintsCard" style="display:flex; flex-direction:column; gap:8px; flex-wrap:wrap; grid-column:1/-1;">
              <div class="lab-section-header">
                <div class="section-title">Contraintes</div>
                <details class="param-help-inline heading lab-help-header"><summary>Aide</summary><div class="param-help">Limitez la durée (Temps s), le nombre total d’évaluations (Max évals), ou exigez un score minimum. Laissez 0 pour ne pas contraindre. Ces contraintes s’appliquent à toutes les stratégies d’optimisation.</div></details>
              </div>
              <div class="lab-section-body" style="align-items:flex-start;">
                <label style="display:none;"><input id="labFocusDD" type="checkbox" /> Min DD</label>
                <label style="display:none;"><input id="labFocusSharpe" type="checkbox" /> Sharpe</label>
                <label style="display:none;"><input id="labFocusPF" type="checkbox" /> PF</label>
                <label style="display:none;"><input id="labFocusSlope" type="checkbox" /> Slope</label>
                <label style="display:none;"><input id="labFocusRecov" type="checkbox" /> Recovery</label>
                <label style="display:none;"><input id="labFocusCons" type="checkbox" /> Consistency</label>
                <label title="Temps limite de calcul (secondes); 0 = désactivé"><details class="param-help-inline"><summary>Temps (s)</summary><div class="param-help">Stoppe automatiquement l'entraînement après N secondes. Mettre 0 pour désactiver toute limite de temps.</div></details><input id="labTimeLimitSec" type="number" min="0" step="1" value="0" style="width:6rem" /></label>
                <label title="Nombre maximal d'évaluations globales; 0 = désactivé">Max évals <input id="labMaxEvals" type="number" min="0" step="1" value="0" style="width:7rem" /></label>
                <label title="Score minimum (0-100); 0 = désactivé">Score min <input id="labMinScore" type="number" min="0" max="100" step="0.1" value="0" style="width:6rem" /></label>
              </div>
            </div>
            <div id="labAdvPanel" style="display:none; gap:12px; align-items:center; flex-wrap:wrap; padding:6px; border:1px dashed var(--header-border); border-radius:6px; grid-column:1/-1;">
              <details class="param-help-inline heading"><summary>Paramètres à tester</summary><div class="param-help">Cochez les paramètres que l’algorithme pourra modifier. Les plages d’étude définissent Min/Max/Pas pour chaque paramètre coché. Astuce: partez large, puis resserrez progressivement.</div></details>
              <label><input id="labVarNol" type="checkbox" checked /> NOL</label>
              <label><input id="labVarPrd" type="checkbox" checked /> PRD</label>
              <label><input id="labVarSLInit" type="checkbox" checked /> SL initial %</label>
              <label><input id="labVarBEBars" type="checkbox" checked /> Bars BE</label>
              <label><input id="labVarBELock" type="checkbox" checked /> Lock %</label>
              <label><input id="labVarEMALen" type="checkbox" checked /> EMA len</label>
              <label><input id="labVarTP" type="checkbox" checked /> TP ladder</label>
              <label><input id="labVarSL" type="checkbox" checked /> SL ladder</label>
              <label>Variations
                <select id="labVarIntensity" style="min-width:8rem;">
                  <option value="weak">Faible</option>
                  <option value="medium" selected>Moyenne</option>
                  <option value="strong">Forte</option>
                </select>
              </label>
              <!-- Entrées (optionnel) -->
              <label style="display:none;"><input id="labVarEntries" type="checkbox" /> Entrées (mode/FibRet/Confirm/382/500/618/786)</label>
            </div>
            <!-- Ranges for core params (shown in Avancée when toggles are ON) -->
            <div id="labCoreRanges" style="display:none; gap:10px; align-items:center; flex-wrap:wrap; margin:6px 0 0; padding:6px; border:1px dashed var(--header-border); border-radius:6px; grid-column:1/-1;">
              <div class="section-title">Plages d'étude</div>
              <div class="core-range-head"><span>Min</span><span>Max</span><span>Pas</span></div>
              <label title="NOL (barres de renversement)" class="core-range-row" style="width:100%;">
                <span class="col"><details class="param-help-inline"><summary>NOL</summary><div class="param-help">Nombre de barres de renversement utilisées pour détecter les swings. Plus grand = signaux plus rares et plus robustes ; plus petit = plus réactif mais plus bruité.</div></details>Min <input id="labNolMin" type="number" min="1" value="2" style="width:5rem" /></span>
                <span class="col">Max <input id="labNolMax" type="number" min="1" value="5" style="width:5rem" /></span>
                <span class="col">Pas <input id="labNolStep" type="number" min="1" value="1" style="width:5rem" /></span>
              </label>
              <label title="Période pivots" class="core-range-row" style="width:100%;">
                <span class="col"><details class="param-help-inline"><summary>PRD</summary><div class="param-help">Période (prd) pour pivots/zigzag. Plus grand = swings plus larges et moins nombreux ; plus petit = détection plus sensible.</div></details>Min <input id="labPrdMin" type="number" min="2" value="8" style="width:5rem" /></span>
                <span class="col">Max <input id="labPrdMax" type="number" min="2" value="34" style="width:5rem" /></span>
                <span class="col">Pas <input id="labPrdStep" type="number" min="1" value="2" style="width:5rem" /></span>
              </label>
              <label title="SL initial (%)" class="core-range-row" style="width:100%;">
                <span class="col"><details class="param-help-inline"><summary>SL initial %</summary><div class="param-help">Stop initial en pourcentage du prix d'entrée. Plus grand = stop large (moins d'arrêts, pertes potentielles plus grandes) ; plus petit = stop serré (plus d'arrêts, pertes limitées).</div></details>Min <input id="labSLInitMin" type="number" min="0" step="0.1" value="0.5" style="width:6rem" /></span>
                <span class="col">Max <input id="labSLInitMax" type="number" min="0" step="0.1" value="3.0" style="width:6rem" /></span>
                <span class="col">Pas <input id="labSLInitStep" type="number" min="0.1" step="0.1" value="0.5" style="width:6rem" /></span>
              </label>
              <label title="Bars jusqu'au BE" class="core-range-row" style="width:100%;">
                <span class="col"><details class="param-help-inline"><summary>BE bars</summary><div class="param-help">Nombre de barres à attendre après l'entrée avant de déplacer le stop au break-even (prix d'entrée). Plus petit = passage au BE plus rapide.</div></details>Min <input id="labBEBarsMin" type="number" min="1" value="3" style="width:5rem" /></span>
                <span class="col">Max <input id="labBEBarsMax" type="number" min="1" value="8" style="width:5rem" /></span>
                <span class="col">Pas <input id="labBEBarsStep" type="number" min="1" value="1" style="width:5rem" /></span>
              </label>
              <label title="Lock (%) au BE" class="core-range-row" style="width:100%;">
                <span class="col"><details class="param-help-inline"><summary>BE lock%</summary><div class="param-help">Décalage au-delà de l'entrée lors du passage au BE : verrouille un petit gain (exprimé en %). Plus grand = on sécurise davantage mais on peut sortir plus tôt.</div></details>Min <input id="labBELockMin" type="number" min="0" step="0.5" value="3" style="width:6rem" /></span>
                <span class="col">Max <input id="labBELockMax" type="number" min="0" step="0.5" value="10" style="width:6rem" /></span>
                <span class="col">Pas <input id="labBELockStep" type="number" min="0.5" step="0.5" value="1" style="width:6rem" /></span>
              </label>
              <label title="EMA filtre" class="core-range-row" style="width:100%;">
                <span class="col"><details class="param-help-inline"><summary>EMA len</summary><div class="param-help">Longueur de l'EMA utilisée comme filtre/confirmation. Plus grande = tendance plus lisse ; plus petite = plus réactive.</div></details>Min <input id="labEMALenMin" type="number" min="1" value="21" style="width:6rem" /></span>
                <span class="col">Max <input id="labEMALenMax" type="number" min="1" value="89" style="width:6rem" /></span>
                <span class="col">Pas <input id="labEMALenStep" type="number" min="1" value="4" style="width:6rem" /></span>
              </label>
            </div>
            <div id="labTPOptBlock" style="display:none; gap:10px; align-items:center; flex-wrap:wrap; margin-top:6px; grid-column:1/-1;">
              <details class="param-help-inline heading"><summary>TP Opt</summary><div class="param-help">Active l'optimisation des TP. Choisissez le nombre de TP et les méthodes autorisées : Fib (ratios), Percent (intervalle %) ou EMA. Les TP sélectionnés sont rendus uniques quand c’est possible et affectés aux TP1..TPn (croissant). La répartition “Cap/TP” est visible dans le résumé.</div></details>
              <label><input id="labTPOptEn" type="checkbox" /> Optimiser TP</label>
              <label>Nb TP <input id="labTPCount" type="number" min="1" max="10" value="10" style="width:5rem" /></label>
              <label><input id="labTPAllowFib" type="checkbox" checked /> Fib</label>
              <label><input id="labTPAllowPct" type="checkbox" /> Percent</label>
              <label><input id="labTPAllowEMA" type="checkbox" /> EMA</label>
              <label title="Pourcentage TP (si Percent)">Min % <input id="labTPPctMin" type="number" min="0" step="0.1" value="0.5" style="width:5rem" /></label>
              <label title="Pourcentage TP (si Percent)">Max % <input id="labTPPctMax" type="number" min="0" step="0.1" value="5.0" style="width:5rem" /></label>
            </div>
            <div id="labTPFibWrap" style="display:none; gap:10px; flex-wrap:wrap; margin-bottom:6px; grid-column:1/-1;">
              <details class="param-help-inline heading"><summary>Ratios Fib TP</summary><div class="param-help">Sélectionnez les ratios Fibonacci autorisés pour les cibles (TP). Les ratios < 1 sont des retracements, > 1 des extensions (objectifs plus éloignés).</div></details>
              <label><input type="checkbox" data-r="0.236" checked />0.236</label>
              <label><input type="checkbox" data-r="0.382" checked />0.382</label>
              <label><input type="checkbox" data-r="0.5" checked />0.500</label>
              <label><input type="checkbox" data-r="0.618" checked />0.618</label>
              <label><input type="checkbox" data-r="0.786" />0.786</label>
              <label><input type="checkbox" data-r="1" checked />1.000</label>
              <label><input type="checkbox" data-r="1.272" />1.272</label>
              <label><input type="checkbox" data-r="1.382" />1.382</label>
              <label><input type="checkbox" data-r="1.414" />1.414</label>
              <label><input type="checkbox" data-r="1.618" checked />1.618</label>
              <label><input type="checkbox" data-r="2" />2.000</label>
              <label><input type="checkbox" data-r="2.236" />2.236</label>
              <label><input type="checkbox" data-r="2.618" />2.618</label>
              <label><input type="checkbox" data-r="3" />3.000</label>
            </div>
            <div id="labSLOptBlock" style="display:none; gap:10px; align-items:center; flex-wrap:wrap; margin-top:6px; grid-column:1/-1;">
              <details class="param-help-inline heading"><summary>SL Opt</summary><div class="param-help">Active l'optimisation des SL. Définissez le nombre de SL et les méthodes autorisées. Avec Percent, utilisez Min/Max en %. Les niveaux sont rendus uniques quand c’est possible pour éviter les doublons.</div></details>
              <label><input id="labSLOptEn" type="checkbox" /> Optimiser SL</label>
              <label>Nb SL <input id="labSLCount" type="number" min="1" max="10" value="1" style="width:5rem" /></label>
              <label><input id="labSLAllowFib" type="checkbox" checked /> Fib</label>
              <label><input id="labSLAllowPct" type="checkbox" checked /> Percent</label>
              <label><input id="labSLAllowEMA" type="checkbox" /> EMA</label>
              <label title="Pourcentage SL (si Percent)">Min % <input id="labSLPctMin" type="number" min="0" step="0.1" value="0.5" style="width:5rem" /></label>
              <label title="Pourcentage SL (si Percent)">Max % <input id="labSLPctMax" type="number" min="0" step="0.1" value="5.0" style="width:5rem" /></label>
            </div>
            <div id="labSLFibWrap" style="display:none; gap:10px; flex-wrap:wrap; margin-bottom:6px; grid-column:1/-1;">
              <details class="param-help-inline heading"><summary>Ratios Fib SL</summary><div class="param-help">Sélectionnez les ratios Fibonacci autorisés pour les stops (SL). Typiquement des retracements (ex: 0.382–0.618). À combiner avec l’option Percent/EMA si activée.</div></details>
              <label><input type="checkbox" data-r="0.236" />0.236</label>
              <label><input type="checkbox" data-r="0.382" checked />0.382</label>
              <label><input type="checkbox" data-r="0.5" checked />0.500</label>
              <label><input type="checkbox" data-r="0.618" checked />0.618</label>
              <label><input type="checkbox" data-r="0.786" />0.786</label>
              <label><input type="checkbox" data-r="1" />1.000</label>
              <label><input type="checkbox" data-r="1.272" />1.272</label>
              <label><input type="checkbox" data-r="1.382" />1.382</label>
              <label><input type="checkbox" data-r="1.414" />1.414</label>
              <label><input type="checkbox" data-r="1.618" />1.618</label>
            </div>
          </div>
          <div id="labSummary" style="margin-bottom:4px; color:var(--muted);"></div>
          <div class="lab-sort-controls" style="margin-bottom:10px; display:flex; gap:8px; align-items:center;">
            <label for="labSortMode" style="display:inline-flex; align-items:center; gap:6px; font-size:13px; color:var(--muted);">
              <span>Classement</span>
              <select id="labSortMode" style="padding:2px 4px; font-size:13px;">
                <option value="score">Meilleurs scores</option>
                <option value="pnl">Meilleurs P&amp;L</option>
              </select>
            </label>
          </div>
          <div class="lab-fixed-actions" style="display:flex; gap:8px; justify-content:space-between; align-items:center;">
            <label id="labAutoLoopLabel" for="labAutoLoop" class="btn" title="Relancer automatiquement l'entraînement" style="display:inline-flex; align-items:center; gap:6px; cursor:pointer;">
              <input id="labAutoLoop" type="checkbox" style="width:auto; height:auto; margin:0; cursor:pointer;" />
              <span>Auto-loop</span>
            </label>
            <div style="display:flex; gap:8px;">
              <button id="labRun" class="btn primary">Entraîner</button>
              <button id="labRunNew" class="btn">Nouvelle stratégie</button>
            </div>
          </div>
          <!-- KPIs + Logs inline (no extra tab/dock) -->
          <div class="lab-panels">
            <div class="kpi-cards">
              <div class="kpi-item"><div class="kpi-label">Score</div><div id="kpiScore" class="kpi-value">—</div></div>
              <div class="kpi-item"><div class="kpi-label">PF</div><div id="kpiPF" class="kpi-value">—</div></div>
              <div class="kpi-item"><div class="kpi-label">Win%</div><div id="kpiWin" class="kpi-value">—</div></div>
              <div class="kpi-item"><div class="kpi-label">Max DD</div><div id="kpiDD" class="kpi-value">—</div></div>
            </div>
            <div class="log-panel">
              <div class="card-header" style="margin-bottom:6px; display:flex; align-items:center; justify-content:space-between; gap:8px;">
                <strong>Logs</strong>
                <span id="labRunStatus" style="color:var(--muted); font-size:12px;">Idle</span>
              </div>
              <pre id="labLog" style="margin:0; max-height:30vh; overflow:auto; white-space:pre-wrap; background:var(--header-bg); padding:6px; border-radius:6px;">—</pre>
            </div>
          </div>
          <div style="overflow:auto; max-height:60vh; margin-top:10px;">
            <table class="lbc-table" style="width:100%">
              <thead>
                <tr>
                  <th>#</th><th>Pair</th><th>TF</th><th>Nom</th><th>Gen</th><th>Paramètres</th><th title="Score brut = score direct (pondérations)">Score brut</th><th title="Score robuste = moyenne de variantes (brut, jitter, splits) − pénalité de variance (≤ 5 pts)">Score robuste</th><th>PF</th><th>P&L</th><th>Cap. final</th><th>Trades</th><th>Win%</th><th>Avg RR</th><th>Max DD</th><th>Actions</th>
                </tr>
              </thead>
              <tbody id="labTBody"><tr><td colspan="16">Aucune donnée</td></tr></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <span style="color:var(--muted);">Les données sont agrégées à partir des optimisations effectuées (symbole courant + TF sélectionné).</span>
        </div>
      </div>
    </div>

    <!-- Lab simple detail modal (empty for now) -->
    <div id="labSimpleDetailModal" class="modal hidden" aria-hidden="true" role="dialog">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-content small" style="max-width:600px;">
        <div class="modal-header">
          <h2>Détail stratégie</h2>
          <button id="labSimpleDetailClose" class="icon-btn" aria-label="Fermer">×</button>
        </div>
        <div class="modal-body">
          <div id="labSimpleDetailBody" style="color:var(--muted);">—</div>
        </div>
      </div>
    </div>
    
    <!-- Supabase config modal -->
    <div id="supaModal" class="modal hidden" aria-hidden="true" role="dialog">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-content" style="max-width:520px;">
        <div class="modal-header">
          <h2>Configuration Supabase</h2>
          <button id="supaClose" class="icon-btn" aria-label="Fermer">×</button>
        </div>
        <div class="modal-body">
          <div class="form-grid" style="grid-template-columns: 1fr; gap:10px;">
            <label>SUPABASE_URL <input id="supaUrl" type="text" placeholder="https://xxx.supabase.co" /></label>
            <label>SUPABASE_ANON_KEY <input id="supaAnon" type="text" placeholder="eyJhbGciOi... (anon public)" /></label>
            <div id="supaMsg" style="color:var(--muted); font-size:12px;"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="supaSave" class="btn primary">Tester & Enregistrer</button>
        </div>
      </div>
    </div>

    <!-- Lightweight Charts vendored (UMD) for static deploy -->
    <script src="vendor/lightweight-charts.standalone.production.js"></script>
    <!-- Supabase UMD client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <!-- Centralized Supabase config (global constants) -->
    <script src="src/supa_config.js"></script>
    <script src="src/supa_ui.js"></script>
    <script src="src/main.js"></script>
  </body>
</html>

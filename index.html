<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chart - BTC/USDC</title>
    <!-- CSP assouplie pour le dev local -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data: https:; style-src 'self' 'unsafe-inline'; script-src 'self' blob: https://cdn.jsdelivr.net; worker-src 'self' blob:; connect-src 'self' https://api.binance.com wss://stream.binance.com:9443 https://*.supabase.co https://*.supabase.net wss://*.supabase.co wss://*.supabase.net; font-src 'self' data:;">
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header>
      <h1 id="pairTitle">BTC/USDC</h1>
      <div class="controls">
        <label for="symbol">Symbole</label>
        <select id="symbol">
          <option value="BTCUSDC" selected>BTC/USDC</option>
          <option value="ETHUSDC">ETH/USDC</option>
          <option value="BNBUSDC">BNB/USDC</option>
        </select>
        <label for="interval">Intervalle</label>
        <select id="interval">
          <option value="1m">1m</option>
          <option value="5m">5m</option>
          <option value="15m">15m</option>
          <option value="1h" selected>1h</option>
          <option value="4h">4h</option>
          <option value="1d">1d</option>
        </select>
        <label class="hdr-toggle" id="emaCtrl" title="Activer/Désactiver l'affichage des EMA/MA">
          <input id="emaToggle" type="checkbox" checked />
          <button id="emaCfg" class="link-btn" type="button" title="Paramètres EMA/MA">EMA ⚙</button>
        </label>
        <label class="hdr-toggle" id="heavenCtrl" title="Activer/Désactiver Heaven">
          <input id="toggleLBC" type="checkbox" />
          <button id="heavenCfg" class="link-btn" type="button" title="Paramètres Heaven">Heaven ⚙</button>
        </label>
        <button id="btRunVisible" class="btn">Backtest</button>
        <button id="labOpen" class="btn" title="Recherche/Apprentissage par TF">Lab</button>
        <button id="liveOpen" class="btn" title="Paper/Live trading">Live</button>
        <span id="status" class="status"></span>
      </div>
    </header>
    <main>
      <div id="chart">
      <div id="lbc-overlay" class="lbc-overlay">
          <div id="lbc-prob" class="lbc-card hidden"></div>
          <div id="lbc-table" class="lbc-card hidden"></div>
        </div>
        <button id="gotoEndBtn" class="btn">⏭ Aller à la fin</button>
      </div>
    </main>

    <div id="lbcModal" class="modal hidden" aria-hidden="true" role="dialog">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h2>Paramètres Heaven</h2>
          <button id="lbcClose" class="icon-btn" aria-label="Fermer">×</button>
        </div>
        <div class="modal-body">
          <form id="lbcForm" class="form-grid">
            <fieldset>
              <legend>Général</legend>
              <label><input type="checkbox" id="optEnabled" /> Activer Heaven</label>
              <label>NOL <input id="optNol" type="number" min="1" value="3" style="width:4.5rem" /></label>
              <label><input type="checkbox" id="optRiskMgmt" /> Gestion du risque</label>
              <label>Max Risk % <input id="optRiskPct" type="number" min="0" step="0.1" value="1.0" style="width:5.5rem" /></label>
              <label><input type="checkbox" id="optShowTrend" checked /> Trendline (reversal)</label>
              <label>Trend Up <input id="optTrendUp" type="color" value="#00ff00" /></label>
              <label>Trend Down <input id="optTrendDn" type="color" value="#ff0000" /></label>
              <label><input type="checkbox" id="optShowClose" checked /> Ligne de clôture</label>
              <label><input type="checkbox" id="optShowArrows" checked /> Afficher flèches (entrées)</label>
              <label>Offset (px) <input id="optArrowOffsetPx" type="number" min="0" step="1" value="8" style="width:5rem" /></label>
              <label>Entry Mode
                <select id="optEntryMode">
                  <option value="Original">Original</option>
                  <option value="Fib Retracement">Fib Retracement</option>
                  <option value="Both" selected>Both</option>
                </select>
              </label>
            </fieldset>
            <fieldset>
              <legend>Stops & BE</legend>
              <label>SL initial % <input id="optSLInitPct" type="number" min="0" step="0.1" value="2.0" style="width:5.5rem" /></label>
              <label><input type="checkbox" id="optBEEnable" checked /> Break-even</label>
              <label>Bars to BE <input id="optBEBars" type="number" min="1" value="5" style="width:4.5rem" /></label>
              <label>Lock % move <input id="optBELockPct" type="number" min="0" step="0.1" value="5.0" style="width:5.5rem" /></label>
            </fieldset>
            <fieldset>
              <legend>SL Ladder</legend>
              <label><input type="checkbox" id="optSLEnable" /> Activer</label>
              <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 10px;">
                <div>
                  <label>SL1 type
                    <select id="optSL1Type">
                      <option value="Percent" selected>Percent</option>
                      <option value="Fib">Fibonacci</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>SL1 value
                    <input id="optSL1R" type="number" step="0.001" value="2.000" style="width:6rem" />
                    <select id="optSL1Fib" style="width:8rem; display:none;">
                      <option value="0.236">0.236</option>
                      <option value="0.382" selected>0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                    </select>
                    <select id="optSL1Ema" style="width:8rem; display:none;"></select>
                  </label>
                </div>
                <!-- rows 2..10 -->
                
                <!-- We'll keep minimal rows for now (1 shown) to avoid UI bloat; additional rows can be toggled later -->
                
              </div>
              <p style="color:var(--muted); font-size:12px; margin:4px 0 0;">Le premier SL valide (sous l'entrée pour un long, au-dessus pour un short) est utilisé; sinon, on revient à "SL initial %".</p>
            </fieldset>
            <fieldset>
              <legend>ZigZag & Fibonacci</legend>
              <label>Période (prd) <input id="optPrd" type="number" min="2" max="50" value="15" style="width:4.5rem" /></label>
              <label><input type="checkbox" id="optUseZZDraw" checked /> Dessiner ZigZag</label>
              <label><input type="checkbox" id="optUseFibDraw" checked /> Dessiner Fibonacci</label>
              <label>ZigZag Up <input id="optZZUp" type="color" value="#00ff00" /></label>
              <label>ZigZag Down <input id="optZZDn" type="color" value="#ff0000" /></label>
              <label><input type="checkbox" id="optUseFibRet" /> Entrées Fib</label>
              <label>Confirmation
                <select id="optConfirmMode">
                  <option value="Bounce" selected>Bounce</option>
                  <option value="Touch">Touch</option>
                </select>
              </label>
              <label><input type="checkbox" id="optEnt382" checked /> 0.382</label>
              <label><input type="checkbox" id="optEnt500" checked /> 0.500</label>
              <label><input type="checkbox" id="optEnt618" checked /> 0.618</label>
              <label><input type="checkbox" id="optEnt786" /> 0.786</label>
            </fieldset>
            <fieldset>
              <legend>TP Ladder</legend>
              <label><input type="checkbox" id="optTPEnable" checked /> Activer</label>
              <label>EMA trail len <input id="optEMALen" type="number" min="1" value="55" style="width:4.5rem" /></label>
              <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 10px;">
                <div>
                  <label>TP1 type
                    <select id="optTP1Type">
                      <option value="Fib" selected>Fibonacci</option>
                      <option value="Percent">Percent</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>TP1 target
                    <input id="optTP1R" type="number" step="0.001" value="0.382" style="width:6rem" />
                    <select id="optTP1Fib" style="width:8rem; display:none;">
                      <option value="0">0.000</option>
                      <option value="0.236">0.236</option>
                      <option value="0.382">0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                      <option value="2.618">2.618</option>
                      <option value="3">3.000</option>
                      <option value="3.618">3.618</option>
                      <option value="4.236">4.236</option>
                      <option value="5">5.000</option>
                    </select>
                    <select id="optTP1Ema" style="width:8rem; display:none;"></select>
                  </label>
                  <label>% capital TP1 <input id="optTP1P" type="number" min="0" max="100" step="1" value="10" style="width:5rem" /></label>
                </div>
                <div>
                  <label>TP2 type
                    <select id="optTP2Type">
                      <option value="Fib" selected>Fibonacci</option>
                      <option value="Percent">Percent</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>TP2 target
                    <input id="optTP2R" type="number" step="0.001" value="0.500" style="width:6rem" />
                    <select id="optTP2Fib" style="width:8rem; display:none;">
                      <option value="0">0.000</option>
                      <option value="0.236">0.236</option>
                      <option value="0.382">0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                      <option value="2.618">2.618</option>
                      <option value="3">3.000</option>
                      <option value="3.618">3.618</option>
                      <option value="4.236">4.236</option>
                      <option value="5">5.000</option>
                    </select>
                    <select id="optTP2Ema" style="width:8rem; display:none;"></select>
                  </label>
                  <label>% capital TP2 <input id="optTP2P" type="number" min="0" max="100" step="1" value="15" style="width:5rem" /></label>
                </div>
                <div>
                  <label>TP3 type
                    <select id="optTP3Type">
                      <option value="Fib" selected>Fibonacci</option>
                      <option value="Percent">Percent</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>TP3 target
                    <input id="optTP3R" type="number" step="0.001" value="0.680" style="width:6rem" />
                    <select id="optTP3Fib" style="width:8rem; display:none;">
                      <option value="0">0.000</option>
                      <option value="0.236">0.236</option>
                      <option value="0.382">0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                      <option value="2.618">2.618</option>
                      <option value="3">3.000</option>
                      <option value="3.618">3.618</option>
                      <option value="4.236">4.236</option>
                      <option value="5">5.000</option>
                    </select>
                    <select id="optTP3Ema" style="width:8rem; display:none;"></select>
                  </label>
                  <label>% capital TP3 <input id="optTP3P" type="number" min="0" max="100" step="1" value="15" style="width:5rem" /></label>
                </div>
                <div>
                  <label>TP4 type
                    <select id="optTP4Type">
                      <option value="Fib" selected>Fibonacci</option>
                      <option value="Percent">Percent</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>TP4 target
                    <input id="optTP4R" type="number" step="0.001" value="1.000" style="width:6rem" />
                    <select id="optTP4Fib" style="width:8rem; display:none;">
                      <option value="0">0.000</option>
                      <option value="0.236">0.236</option>
                      <option value="0.382">0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                      <option value="2.618">2.618</option>
                      <option value="3">3.000</option>
                      <option value="3.618">3.618</option>
                      <option value="4.236">4.236</option>
                      <option value="5">5.000</option>
                    </select>
                    <select id="optTP4Ema" style="width:8rem; display:none;"></select>
                  </label>
                  <label>% capital TP4 <input id="optTP4P" type="number" min="0" max="100" step="1" value="10" style="width:5rem" /></label>
                </div>
                <div>
                  <label>TP5 type
                    <select id="optTP5Type">
                      <option value="Fib" selected>Fibonacci</option>
                      <option value="Percent">Percent</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>TP5 target
                    <input id="optTP5R" type="number" step="0.001" value="1.382" style="width:6rem" />
                    <select id="optTP5Fib" style="width:8rem; display:none;">
                      <option value="0">0.000</option>
                      <option value="0.236">0.236</option>
                      <option value="0.382">0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                      <option value="2.618">2.618</option>
                      <option value="3">3.000</option>
                      <option value="3.618">3.618</option>
                      <option value="4.236">4.236</option>
                      <option value="5">5.000</option>
                    </select>
                    <select id="optTP5Ema" style="width:8rem; display:none;"></select>
                  </label>
                  <label>% capital TP5 <input id="optTP5P" type="number" min="0" max="100" step="1" value="10" style="width:5rem" /></label>
                </div>
                <div>
                  <label>TP6 type
                    <select id="optTP6Type">
                      <option value="Fib" selected>Fibonacci</option>
                      <option value="Percent">Percent</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>TP6 target
                    <input id="optTP6R" type="number" step="0.001" value="1.618" style="width:6rem" />
                    <select id="optTP6Fib" style="width:8rem; display:none;">
                      <option value="0">0.000</option>
                      <option value="0.236">0.236</option>
                      <option value="0.382">0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                      <option value="2.618">2.618</option>
                      <option value="3">3.000</option>
                      <option value="3.618">3.618</option>
                      <option value="4.236">4.236</option>
                      <option value="5">5.000</option>
                    </select>
                    <select id="optTP6Ema" style="width:8rem; display:none;"></select>
                  </label>
                  <label>% capital TP6 <input id="optTP6P" type="number" min="0" max="100" step="1" value="10" style="width:5rem" /></label>
                </div>
                <div>
                  <label>TP7 type
                    <select id="optTP7Type">
                      <option value="Fib" selected>Fibonacci</option>
                      <option value="Percent">Percent</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>TP7 target
                    <input id="optTP7R" type="number" step="0.001" value="2.000" style="width:6rem" />
                    <select id="optTP7Fib" style="width:8rem; display:none;">
                      <option value="0">0.000</option>
                      <option value="0.236">0.236</option>
                      <option value="0.382">0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                      <option value="2.618">2.618</option>
                      <option value="3">3.000</option>
                      <option value="3.618">3.618</option>
                      <option value="4.236">4.236</option>
                      <option value="5">5.000</option>
                    </select>
                    <select id="optTP7Ema" style="width:8rem; display:none;"></select>
                  </label>
                  <label>% capital TP7 <input id="optTP7P" type="number" min="0" max="100" step="1" value="10" style="width:5rem" /></label>
                </div>
                <div>
                  <label>TP8 type
                    <select id="optTP8Type">
                      <option value="Fib" selected>Fibonacci</option>
                      <option value="Percent">Percent</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>TP8 target
                    <input id="optTP8R" type="number" step="0.001" value="2.236" style="width:6rem" />
                    <select id="optTP8Fib" style="width:8rem; display:none;">
                      <option value="0">0.000</option>
                      <option value="0.236">0.236</option>
                      <option value="0.382">0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                      <option value="2.618">2.618</option>
                      <option value="3">3.000</option>
                      <option value="3.618">3.618</option>
                      <option value="4.236">4.236</option>
                      <option value="5">5.000</option>
                    </select>
                    <select id="optTP8Ema" style="width:8rem; display:none;"></select>
                  </label>
                  <label>% capital TP8 <input id="optTP8P" type="number" min="0" max="100" step="1" value="10" style="width:5rem" /></label>
                </div>
                <div>
                  <label>TP9 type
                    <select id="optTP9Type">
                      <option value="Fib" selected>Fibonacci</option>
                      <option value="Percent">Percent</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>TP9 target
                    <input id="optTP9R" type="number" step="0.001" value="2.618" style="width:6rem" />
                    <select id="optTP9Fib" style="width:8rem; display:none;">
                      <option value="0">0.000</option>
                      <option value="0.236">0.236</option>
                      <option value="0.382">0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                      <option value="2.618">2.618</option>
                      <option value="3">3.000</option>
                      <option value="3.618">3.618</option>
                      <option value="4.236">4.236</option>
                      <option value="5">5.000</option>
                    </select>
                    <select id="optTP9Ema" style="width:8rem; display:none;"></select>
                  </label>
                  <label>% capital TP9 <input id="optTP9P" type="number" min="0" max="100" step="1" value="5" style="width:5rem" /></label>
                </div>
                <div>
                  <label>TP10 type
                    <select id="optTP10Type">
                      <option value="Fib" selected>Fibonacci</option>
                      <option value="Percent">Percent</option>
                      <option value="EMA">EMA</option>
                    </select>
                  </label>
                  <label>TP10 target
                    <input id="optTP10R" type="number" step="0.001" value="3.000" style="width:6rem" />
                    <select id="optTP10Fib" style="width:8rem; display:none;">
                      <option value="0">0.000</option>
                      <option value="0.236">0.236</option>
                      <option value="0.382">0.382</option>
                      <option value="0.5">0.500</option>
                      <option value="0.618">0.618</option>
                      <option value="0.786">0.786</option>
                      <option value="1">1.000</option>
                      <option value="1.272">1.272</option>
                      <option value="1.414">1.414</option>
                      <option value="1.618">1.618</option>
                      <option value="2">2.000</option>
                      <option value="2.618">2.618</option>
                      <option value="3">3.000</option>
                      <option value="3.618">3.618</option>
                      <option value="4.236">4.236</option>
                      <option value="5">5.000</option>
                    </select>
                    <select id="optTP10Ema" style="width:8rem; display:none;"></select>
                  </label>
                  <label>% capital TP10 <input id="optTP10P" type="number" min="0" max="100" step="1" value="5" style="width:5rem" /></label>
                </div>
              </div>
            </fieldset>
          </form>
        </div>
        <div class="modal-footer" style="flex-wrap:wrap; gap:8px; align-items:center;">
          <div style="display:flex; gap:6px; align-items:center; flex:1 1 auto; min-width:260px;">
            <input id="lbcPresetName" type="text" placeholder="Nom du preset" style="flex:1 1 auto; min-width:160px;" />
            <button id="lbcPresetSave" class="btn">Sauvegarder preset</button>
          </div>
          <div style="display:flex; gap:6px; align-items:center; flex:1 1 auto; min-width:260px;">
            <select id="lbcPresetSelect" style="flex:1 1 auto; min-width:160px;"></select>
            <button id="lbcPresetLoad" class="btn">Charger</button>
            <button id="lbcPresetDelete" class="btn">Supprimer</button>
          </div>
          <span style="flex:1 1 100%; height:0;"></span>
          <button id="lbcReset" class="btn">Réinitialiser</button>
          <button id="lbcSave" class="btn primary">Enregistrer</button>
        </div>
      </div>
    </div>

    <!-- EMA/MA modal -->
    <div id="emaModal" class="modal hidden" aria-hidden="true" role="dialog">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h2>EMA / MA</h2>
          <button id="emaClose" class="icon-btn" aria-label="Fermer">×</button>
        </div>
        <div class="modal-body">
          <form class="form-grid">
            <fieldset>
              <legend>EMA</legend>
              <label><input id="ema21En" type="checkbox" checked /> EMA <input id="ema21Len" type="number" value="21" style="width:5rem" /> <input id="ema21Col" type="color" value="#facc15" /></label>
              <label><input id="ema34En" type="checkbox" checked /> EMA <input id="ema34Len" type="number" value="34" style="width:5rem" /> <input id="ema34Col" type="color" value="#ffa500" /></label>
              <label><input id="ema55En" type="checkbox" checked /> EMA <input id="ema55Len" type="number" value="55" style="width:5rem" /> <input id="ema55Col" type="color" value="#ef4444" /></label>
              <label><input id="ema200En" type="checkbox" checked /> EMA <input id="ema200Len" type="number" value="200" style="width:5rem" /> <input id="ema200Col" type="color" value="#000000" /></label>
            </fieldset>
            <fieldset>
              <legend>MA</legend>
              <label><input id="ma5En" type="checkbox" checked /> MA <input id="ma5Len" type="number" value="5" style="width:5rem" /> <input id="ma5Col" type="color" value="#3b82f6" /></label>
              <label><input id="ma8En" type="checkbox" checked /> MA <input id="ma8Len" type="number" value="8" style="width:5rem" /> <input id="ma8Col" type="color" value="#00ffff" /></label>
              <label><input id="ma13En" type="checkbox" checked /> MA <input id="ma13Len" type="number" value="13" style="width:5rem" /> <input id="ma13Col" type="color" value="#22c55e" /></label>
            </fieldset>
          </form>
        </div>
        <div class="modal-footer">
          <button id="emaSave" class="btn primary">Enregistrer</button>
        </div>
      </div>
    </div>

    <!-- Backtest progress modal -->
    <div id="btProgress" class="modal hidden" aria-hidden="true" role="dialog">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-content small">
        <div class="modal-header">
          <h2>Simulation</h2>
        </div>
        <div class="modal-body">
          <div id="btProgText" style="margin-bottom:6px;">Préparation...</div>
          <div class="progress"><div id="btProgBar"></div></div>
          <div id="btProgTime" style="margin-top:6px; font-size:12px;">⏱ 00:00</div>
          <div id="btProgNote" style="margin-top:4px; color:var(--muted); font-size:12px;"></div>
          <pre id="btProgLog" style="margin-top:6px; max-height:35vh; overflow:auto; background:var(--bg2, rgba(0,0,0,0.04)); padding:6px; border-radius:4px; font-size:12px; white-space:pre-wrap;">—</pre>
        </div>
        <div class="modal-footer">
          <div style="margin-right:auto; display:flex; gap:8px;">
            <button id="btPause" class="btn" title="Mettre en pause/Reprendre">Pause</button>
            <button id="btStop" class="btn" title="Arrêter">Stop</button>
          </div>
          <button id="btShowDetails" class="btn" title="Afficher la liste complète des évaluations">Détails</button>
          <button id="btExportDetails" class="btn" title="Exporter les évaluations en CSV">Exporter CSV</button>
          <button id="btAbort" class="btn">Annuler</button>
        </div>
      </div>
    </div>

    <!-- Backtest settings modal -->
    <div id="btModal" class="modal hidden" aria-hidden="true" role="dialog">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h2>Paramètres de simulation</h2>
          <button id="btCloseModal" class="icon-btn" aria-label="Fermer">×</button>
        </div>
        <div class="modal-body">
          <form id="btForm" class="form-grid">
            <fieldset>
              <legend>Général</legend>
              <label>Capital initial <input id="btStartCap" type="number" min="0" step="100" value="10000" style="width:8rem" /></label>
              <label>Frais (%) <input id="btFee" type="number" min="0" step="0.01" value="0.10" style="width:6rem" /></label>
              <label>Levier (x) <input id="btLev" type="number" min="1" max="125" step="0.1" value="1" style="width:6rem" /></label>
              <label>Max % par trade <input id="btMaxPct" type="number" min="0" max="100" step="1" value="100" style="width:6rem" /></label>
              <label>Base du capital
                <select id="btMaxBase">
                  <option value="initial" selected>Capital initial</option>
                  <option value="equity">Capital variable</option>
                </select>
              </label>
            </fieldset>
            <fieldset>
              <legend>Période</legend>
              <label><input type="radio" name="btRangeMode" id="btRangeVisible" value="visible" checked /> Période visible</label>
              <label><input type="radio" name="btRangeMode" id="btRangeAll" value="all" /> Tout l'historique</label>
              <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                <label><input type="radio" name="btRangeMode" id="btRangeDates" value="dates" /> Dates</label>
                <label>De <input id="btFrom" type="datetime-local" style="width: 14rem" /></label>
                <label>À <input id="btTo" type="datetime-local" style="width: 14rem" /></label>
              </div>
              <p style="color:var(--muted);font-size:12px;margin:4px 0 0;">Les dates sont interprétées dans votre fuseau horaire local.</p>
            </fieldset>
            <fieldset style="display:none">
              <legend>Optimisation (utiliser le Lab)</legend>
              <p style="color:var(--muted);font-size:12px;margin:0 0 6px;">Optimise sur l'intervalle actuel (sélectionne 1m/5m/15m en haut).</p>
              <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
                <label>Stratégie
                    <select id="btOptStrategy">
                      <option value="grid" selected>Grille</option>
                      <option value="random">Aléatoire</option>
                      <option value="ea">Évolutionnaire</option>
                      <option value="bayes">Bayes (EDA)</option>
                    </select>
                </label>
                <label>TF
                  <select id="btOptInterval" style="min-width:6rem;">
                    <option value="1m">1m</option>
                    <option value="5m">5m</option>
                    <option value="15m">15m</option>
                    <option value="1h">1h</option>
                    <option value="4h">4h</option>
                    <option value="1d">1d</option>
                  </select>
                </label>
                <label>Profil
                  <select id="btOptProfile" style="min-width:8rem;">
                    <option value="sure">Sûre</option>
                    <option value="balancee" selected>Balancée</option>
                    <option value="agressive">Agressive</option>
                  </select>
                </label>
                <label>Max combinaisons <input id="btOptMax" type="number" min="1" max="10000" step="1" value="100" style="width:6rem" /></label>
                <label>Top N <input id="btOptTopN" type="number" min="1" max="1000" step="1" value="20" style="width:6rem" /></label>
              </div>
              <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
                <span>Modes d'entrée:</span>
                <label><input id="btOptEMOrig" type="checkbox" /> Original</label>
                <label><input id="btOptEMFib" type="checkbox" /> Fib Retracement</label>
                <label><input id="btOptEMBoth" type="checkbox" checked /> Both</label>
                <span style="flex:1 1 auto"></span>
                <label title="Utiliser les résultats historiques (même symbole+TF) comme prior pour l'optimisation"><input id="btUseTFPrior" type="checkbox" /> Prior TF</label>
              </div>
              <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px;">
                <div>
                  <label><input id="btOptNolEn" type="checkbox" checked /> NOL</label>
                  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                    <label>Min <input id="btOptNolMin" type="number" min="1" value="2" style="width:5rem" /></label>
                    <label>Max <input id="btOptNolMax" type="number" min="1" value="5" style="width:5rem" /></label>
                    <label>Pas <input id="btOptNolStep" type="number" min="1" value="1" style="width:5rem" /></label>
                  </div>
                </div>
                <div>
                  <label><input id="btOptPrdEn" type="checkbox" checked /> Période (prd)</label>
                  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                    <label>Min <input id="btOptPrdMin" type="number" min="2" value="8" style="width:5rem" /></label>
                    <label>Max <input id="btOptPrdMax" type="number" min="2" value="34" style="width:5rem" /></label>
                    <label>Pas <input id="btOptPrdStep" type="number" min="1" value="2" style="width:5rem" /></label>
                  </div>
                </div>
                <div>
                  <label><input id="btOptSLEn" type="checkbox" checked /> SL initial %</label>
                  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                    <label>Min <input id="btOptSLMin" type="number" min="0" step="0.1" value="0.5" style="width:5rem" /></label>
                    <label>Max <input id="btOptSLMax" type="number" min="0" step="0.1" value="3.0" style="width:5rem" /></label>
                    <label>Pas <input id="btOptSLStep" type="number" min="0.1" step="0.1" value="0.5" style="width:5rem" /></label>
                  </div>
                </div>
                <div>
                  <label><input id="btOptBEBarsEn" type="checkbox" checked /> Bars to BE</label>
                  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                    <label>Min <input id="btOptBEBarsMin" type="number" min="1" value="3" style="width:5rem" /></label>
                    <label>Max <input id="btOptBEBarsMax" type="number" min="1" value="8" style="width:5rem" /></label>
                    <label>Pas <input id="btOptBEBarsStep" type="number" min="1" value="1" style="width:5rem" /></label>
                  </div>
                </div>
                <div>
                  <label><input id="btOptBELockEn" type="checkbox" checked /> Lock % move</label>
                  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                    <label>Min <input id="btOptBELockMin" type="number" min="0" step="0.1" value="3" style="width:5rem" /></label>
                    <label>Max <input id="btOptBELockMax" type="number" min="0" step="0.1" value="10" style="width:5rem" /></label>
                    <label>Pas <input id="btOptBELockStep" type="number" min="0.1" step="0.1" value="1" style="width:5rem" /></label>
                  </div>
                </div>
                <div>
                  <label><input id="btOptEMALenEn" type="checkbox" checked /> EMA len</label>
                  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                    <label>Min <input id="btOptEMALenMin" type="number" min="1" value="21" style="width:5rem" /></label>
                    <label>Max <input id="btOptEMALenMax" type="number" min="1" value="89" style="width:5rem" /></label>
                    <label>Pas <input id="btOptEMALenStep" type="number" min="1" value="4" style="width:5rem" /></label>
                  </div>
                </div>
                <!-- EA params -->
                <div>
                  <label>EA: Pop <input id="btEAPop" type="number" min="4" max="2000" value="40" style="width:6rem" /></label>
                  <label>Gens <input id="btEAGen" type="number" min="1" max="500" value="20" style="width:6rem" /></label>
                  <label>Mut % <input id="btEAMut" type="number" min="0" max="100" step="1" value="20" style="width:6rem" /></label>
                  <label>Cx % <input id="btEACx" type="number" min="0" max="100" step="1" value="60" style="width:6rem" /></label>
                  <label><input id="btEAResume" type="checkbox" /> Resume</label>
                </div>
                <!-- Bayes(EDA) params -->
                <div>
                  <label>Bayes: Iters <input id="btBayIters" type="number" min="10" max="5000" value="150" style="width:6rem" /></label>
                  <label>Init random <input id="btBayInit" type="number" min="5" max="2000" value="40" style="width:8rem" /></label>
                  <label>Elite % <input id="btBayElitePct" type="number" min="5" max="80" step="1" value="30" style="width:6rem" /></label>
                  <label><input id="btBayResume" type="checkbox" /> Resume</label>
                </div>
              </div>
              <div style="margin-top:10px; border-top:1px solid var(--header-border); padding-top:10px;">
                <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
                  <label><input id="btOptTPEn" type="checkbox" /> Optimiser TP (Fib)</label>
                  <label>Nb TP <input id="btOptTPCount" type="number" min="1" max="10" value="3" style="width:5rem" /></label>
                  <span style="color:var(--muted);font-size:12px;">Les ratios sélectionnés seront affectés aux TP1..TPn (ordre croissant)</span>
                </div>
                <div id="btOptTPFibWrap" style="display:flex; gap:10px; flex-wrap:wrap;">
                  <label><input type="checkbox" data-r="0.236" checked />0.236</label>
                  <label><input type="checkbox" data-r="0.382" checked />0.382</label>
                  <label><input type="checkbox" data-r="0.5" checked />0.500</label>
                  <label><input type="checkbox" data-r="0.618" checked />0.618</label>
                  <label><input type="checkbox" data-r="0.786" />0.786</label>
                  <label><input type="checkbox" data-r="1" checked />1.000</label>
                  <label><input type="checkbox" data-r="1.272" />1.272</label>
                  <label><input type="checkbox" data-r="1.414" />1.414</label>
                  <label><input type="checkbox" data-r="1.618" checked />1.618</label>
                  <label><input type="checkbox" data-r="2" />2.000</label>
                  <label><input type="checkbox" data-r="2.618" />2.618</label>
                  <label><input type="checkbox" data-r="3" />3.000</label>
                </div>
              </div>
              <div style="margin-top:10px; border-top:1px solid var(--header-border); padding-top:10px;">
                <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
                  <label><input id="btOptTPPctEn" type="checkbox" /> Optimiser TP (Percent)</label>
                  <label>Nb TP <input id="btOptTPPctCount" type="number" min="1" max="10" value="3" style="width:5rem" /></label>
                  <label>Min % <input id="btOptTPPctMin" type="number" min="0" step="0.1" value="0.5" style="width:5rem" /></label>
                  <label>Max % <input id="btOptTPPctMax" type="number" min="0" step="0.1" value="5.0" style="width:5rem" /></label>
                  <label>Pas % <input id="btOptTPPctStep" type="number" min="0.1" step="0.1" value="0.5" style="width:5rem" /></label>
                </div>
              </div>
              <div style="margin-top:10px; border-top:1px solid var(--header-border); padding-top:10px;">
                <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
                  <label><input id="btOptAllocEn" type="checkbox" /> Optimiser répartition (%)</label>
                  <label>Pas <input id="btOptAllocStep" type="number" min="1" max="50" step="1" value="5" style="width:5rem" /></label>
                  <label>Max patterns <input id="btOptAllocMax" type="number" min="1" max="100" step="1" value="8" style="width:7rem" /></label>
                </div>
              </div>
            </fieldset>
          </form>
        </div>
        <div class="modal-footer">
          <button id="btCancel" class="btn">Annuler</button>
          <button id="btOptimize" class="btn">Optimiser</button>
          <button id="btRun" class="btn primary">Lancer</button>
        </div>
      </div>
    </div>

    <!-- Live trading modal -->
    <div id="liveModal" class="modal hidden" aria-hidden="true" role="dialog">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-content" style="max-width:680px;">
        <div class="modal-header">
          <h2>Live</h2>
          <button id="liveClose" class="icon-btn" aria-label="Fermer">×</button>
        </div>
        <div class="modal-body">
          <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 10px;">
            <fieldset>
              <legend>Mode</legend>
              <label><input type="radio" name="liveMode" id="liveModePaper" value="paper" checked> Paper trading</label>
              <label title="Bientôt"><input type="radio" name="liveMode" id="liveModeReal" value="real" disabled> Live trading</label>
            </fieldset>
            <fieldset>
              <legend>Wallet</legend>
              <label>Portefeuille
                <select id="liveWalletSel">
                  <option value="__new__" selected>+ Nouveau portefeuille…</option>
                </select>
              </label>
              <label>Nom <input id="liveWalletName" type="text" placeholder="Ex: Strat EMA55" /></label>
            </fieldset>
            <fieldset>
              <legend>Paramètres (paper)</legend>
              <label>Capital initial <input id="liveStartCap" type="number" min="0" step="100" value="10000" style="width:8rem" /></label>
              <label>Frais (%) <input id="liveFee" type="number" min="0" step="0.01" value="0.10" style="width:6rem" /></label>
              <label>Levier (x) <input id="liveLev" type="number" min="1" max="125" step="0.1" value="1" style="width:6rem" /></label>
            </fieldset>
          </div>
        </div>
        <div class="modal-footer" style="display:flex; gap:8px; justify-content:flex-end;">
          <button id="liveStop" class="btn">Arrêter</button>
          <button id="liveStart" class="btn primary">Lancer</button>
        </div>
      </div>
    </div>

    <!-- Strategy details modal -->
    <div id="stratModal" class="modal hidden" aria-hidden="true" role="dialog">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-content small" style="max-width:720px;">
        <div class="modal-header">
          <h2>Détails stratégie</h2>
          <div style="display:flex; gap:6px; align-items:center;">
            <button id="stratCollapse" class="icon-btn" title="Replier">▾</button>
            <button id="stratClose" class="icon-btn" aria-label="Fermer">×</button>
          </div>
        </div>
        <div class="modal-body">
          <div id="stratTitle" style="margin-bottom:8px; color:var(--muted);"></div>
          <table class="lbc-table" style="width:100%; table-layout:auto; font-size:12px;">
            <thead>
              <tr><th style="text-align:left;">Critère</th><th>Note / 100</th><th style="text-align:right;">Valeur</th></tr>
            </thead>
            <tbody id="stratTBody"><tr><td colspan="3">—</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Trades details modal -->
    <div id="tradesModal" class="modal hidden" aria-hidden="true" role="dialog">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-content" style="max-width:920px;">
        <div class="modal-header">
          <h2>Historique des trades</h2>
          <span id="tradesHdrCtx" style="margin-left:auto; color:var(--muted); font-size:12px;"></span>
          <div style="display:flex; gap:6px; align-items:center;">
            <button id="tradesCollapse" class="icon-btn" title="Replier">▾</button>
            <button id="tradesClose" class="icon-btn" aria-label="Fermer">×</button>
          </div>
        </div>
        <div class="modal-body">
          <div id="tradesCtx" style="margin-bottom:8px; color:var(--muted);"></div>
          <div style="overflow:auto; max-height:60vh;">
            <table class="lbc-table" style="width:100%; table-layout:auto; font-size:12px;">
              <thead>
                <tr>
                  <th>#</th><th>Horaire</th><th>Capital</th><th>Trade</th><th>Quantité</th><th>Prix entrée</th><th>Prix sortie</th><th>Frais</th><th>P&L</th><th>Durée</th>
                </tr>
              </thead>
              <tbody id="tradesTBody"><tr><td colspan="11">—</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Weights modal -->
    <div id="weightsModal" class="modal hidden" aria-hidden="true" role="dialog">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-content" style="max-width:720px;">
        <div class="modal-header">
          <h2>Pondérations — Score global</h2>
          <button id="weightsClose" class="icon-btn" aria-label="Fermer">×</button>
        </div>
        <div class="modal-body">
          <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
            <label>Profil
              <select id="weightsProfile">
                <option value="sure">Sûre</option>
                <option value="balancee" selected>Balancée</option>
                <option value="agressive">Agressive</option>
              </select>
            </label>
            <span style="color:var(--muted);">Les poids doivent totaliser 100%.</span>
          </div>
          <div id="weightsBody"></div>
        </div>
        <div class="modal-footer">
          <button id="weightsSave" class="btn primary">Enregistrer</button>
        </div>
      </div>
    </div>

    <!-- Strategy detail modal -->
    <div id="detailModal" class="modal hidden" aria-hidden="true" role="dialog">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-content" style="max-width:1000px;">
        <div class="modal-header">
          <h2>Analyse stratégie</h2>
          <button id="detailClose" class="icon-btn" aria-label="Fermer">×</button>
        </div>
        <div class="modal-body">
          <div id="detailCtx" style="margin-bottom:8px; color:var(--muted);"></div>
          <div style="display:grid; grid-template-columns: 1fr; gap:12px;">
            <div style="display:grid; grid-template-columns: 420px 1fr; gap:12px; align-items:start;">
              <canvas id="detailRadar" width="420" height="300" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <div>
                <canvas id="detailEquity" width="520" height="220" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
                <canvas id="detailDD" width="520" height="100" style="margin-top:8px; background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
              <canvas id="detailHist" width="480" height="180" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
              <canvas id="detailEff" width="480" height="180" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
            </div>
            <canvas id="detailRobust" width="980" height="160" style="background:var(--bg); border:1px solid var(--header-border); border-radius:8px;"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Evaluations detail modal -->
    <div id="evalsModal" class="modal hidden" aria-hidden="true" role="dialog">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-content" style="max-width:1000px;">
        <div class="modal-header">
          <h2>Détails des évaluations</h2>
          <button id="evalsClose" class="icon-btn" aria-label="Fermer">×</button>
        </div>
        <div class="modal-body">
          <div id="evalsCtx" style="margin-bottom:8px; color:var(--muted);"></div>
          <div style="overflow:auto; max-height:60vh;">
            <table class="lbc-table" style="width:100%; table-layout:auto; font-size:12px;">
              <thead>
                <tr>
                  <th>#</th><th>Score</th><th>PF</th><th>P&L</th><th>Trades</th><th>Win%</th><th>Avg RR</th><th>Params</th>
                </tr>
              </thead>
              <tbody id="evalsTBody"><tr><td colspan="8">—</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Research / Lab modal -->
    <div id="labModal" class="modal hidden" aria-hidden="true" role="dialog">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-content" style="max-width: 980px;">
        <div class="modal-header">
          <h2>Lab — Recherche par TF</h2>
          <div style="display:flex; gap:8px; align-items:center;">
            <label>TF
              <select id="labTFSelect" style="min-width:6rem;">
                <option value="1m">1m</option>
                <option value="5m">5m</option>
                <option value="15m">15m</option>
                <option value="1h">1h</option>
                <option value="4h">4h</option>
                <option value="1d">1d</option>
              </select>
            </label>
            <button id="labExport" class="btn">Exporter CSV</button>
            <button id="labClear" class="btn" title="Effacer l'historique (symbole+TF)">Nettoyer</button>
            <button id="labWeights" class="btn" title="Pondérations du score">Pondérations</button>
            <button id="labClose" class="icon-btn" aria-label="Fermer">×</button>
          </div>
        </div>
        <div class="modal-body">
          <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:10px; margin-bottom:10px;">
            <label>Profil
              <select id="labProfile" style="min-width:8rem;">
                <option value="sure">Stratégie sûre</option>
                <option value="balancee" selected>Stratégie balancée</option>
                <option value="agressive">Stratégie agressive</option>
              </select>
            </label>
            <label>Objectif
              <select id="labGoal" style="min-width:11rem;">
                <option value="improve" selected>Améliorer stratégie</option>
                <option value="new">Nouvelle stratégie</option>
              </select>
            </label>
            <label>Stratégie
              <select id="labStrategy" style="min-width:12rem;">
                <option value="hybrid" selected>Hybride (EA → Bayes)</option>
                <option value="ea">Évolutionnaire (EA)</option>
                <option value="bayes">Bayes (EDA)</option>
              </select>
            </label>
            <label>Plage
              <select id="labRangeMode" style="min-width:8rem;">
                <option value="visible" selected>Visible</option>
                <option value="all">Tout l'historique</option>
                <option value="dates">Dates</option>
              </select>
            </label>
            <label>De <input id="labFrom" type="datetime-local" style="width: 14rem" /></label>
            <label>À <input id="labTo" type="datetime-local" style="width: 14rem" /></label>
            <label>Capital initial <input id="labStartCap" type="number" min="0" step="100" value="10000" style="width:8rem" /></label>
            <label>Frais (%) <input id="labFee" type="number" min="0" step="0.01" value="0.10" style="width:6rem" /></label>
            <label>Levier (x) <input id="labLev" type="number" min="1" max="125" step="0.1" value="1" style="width:6rem" /></label>
            <label><input id="labUseTFPrior" type="checkbox" checked /> Prior TF</label>
            <label><input id="labResume" type="checkbox" checked /> Apprentissage</label>
            <span></span>
            <div style="display:none; gap:8px; align-items:center; flex-wrap:wrap;">
              <strong>EA</strong>
              <label>Pop <input id="labEAPop" type="number" min="4" max="2000" value="40" style="width:6rem" /></label>
              <label>Gen <input id="labEAGen" type="number" min="1" max="500" value="20" style="width:6rem" /></label>
              <label>Mut% <input id="labEAMut" type="number" min="0" max="100" step="1" value="20" style="width:6rem" /></label>
              <label>Cx% <input id="labEACx" type="number" min="0" max="100" step="1" value="60" style="width:6rem" /></label>
            </div>
            <div style="display:none; gap:8px; align-items:center; flex-wrap:wrap;">
              <strong>Bayes</strong>
              <label>Iters <input id="labBayIters" type="number" min="10" max="5000" value="150" style="width:6rem" /></label>
              <label>Init <input id="labBayInit" type="number" min="5" max="2000" value="40" style="width:6rem" /></label>
              <label>Elite% <input id="labBayElitePct" type="number" min="5" max="80" step="1" value="30" style="width:6rem" /></label>
            </div>
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <strong>Focus</strong>
              <label style="display:none;"><input id="labFocusDD" type="checkbox" /> Min DD</label>
              <label style="display:none;"><input id="labFocusSharpe" type="checkbox" /> Sharpe</label>
              <label style="display:none;"><input id="labFocusPF" type="checkbox" /> PF</label>
              <label style="display:none;"><input id="labFocusSlope" type="checkbox" /> Slope</label>
              <label style="display:none;"><input id="labFocusRecov" type="checkbox" /> Recovery</label>
              <label style="display:none;"><input id="labFocusCons" type="checkbox" /> Consistency</label>
              <label title="Temps limite de calcul (secondes); 0 = désactivé">Temps (s) <input id="labTimeLimitSec" type="number" min="0" step="1" value="0" style="width:6rem" /></label>
              <label title="Score minimum (0-100); 0 = désactivé">Score min <input id="labMinScore" type="number" min="0" max="100" step="0.1" value="0" style="width:6rem" /></label>
              <div style="display:flex; gap:6px; margin-left:auto;">
                <button id="labRun" class="btn primary">Entraîner</button>
              </div>
            </div>
            <div style="display:none; gap:10px; align-items:center; flex-wrap:wrap; margin-top:6px;">
              <strong>TP Opt</strong>
              <label><input id="labTPOptEn" type="checkbox" /> Optimiser TP</label>
              <label>Nb TP <input id="labTPCount" type="number" min="1" max="10" value="10" style="width:5rem" /></label>
              <label><input id="labTPAllowFib" type="checkbox" checked /> Fib</label>
              <label><input id="labTPAllowPct" type="checkbox" /> Percent</label>
              <label><input id="labTPAllowEMA" type="checkbox" /> EMA</label>
              <label title="Pourcentage TP (si Percent)">Min % <input id="labTPPctMin" type="number" min="0" step="0.1" value="0.5" style="width:5rem" /></label>
              <label title="Pourcentage TP (si Percent)">Max % <input id="labTPPctMax" type="number" min="0" step="0.1" value="5.0" style="width:5rem" /></label>
            </div>
            <div id="labTPFibWrap" style="display:none; gap:10px; flex-wrap:wrap; margin-bottom:6px;">
              <label><input type="checkbox" data-r="0.236" checked />0.236</label>
              <label><input type="checkbox" data-r="0.382" checked />0.382</label>
              <label><input type="checkbox" data-r="0.5" checked />0.500</label>
              <label><input type="checkbox" data-r="0.618" checked />0.618</label>
              <label><input type="checkbox" data-r="0.786" />0.786</label>
              <label><input type="checkbox" data-r="1" checked />1.000</label>
              <label><input type="checkbox" data-r="1.272" />1.272</label>
              <label><input type="checkbox" data-r="1.382" />1.382</label>
              <label><input type="checkbox" data-r="1.414" />1.414</label>
              <label><input type="checkbox" data-r="1.618" checked />1.618</label>
              <label><input type="checkbox" data-r="2" />2.000</label>
              <label><input type="checkbox" data-r="2.236" />2.236</label>
              <label><input type="checkbox" data-r="2.618" />2.618</label>
              <label><input type="checkbox" data-r="3" />3.000</label>
            </div>
            <div style="display:none; gap:10px; align-items:center; flex-wrap:wrap; margin-top:6px;">
              <strong>SL Opt</strong>
              <label><input id="labSLOptEn" type="checkbox" /> Optimiser SL</label>
              <label>Nb SL <input id="labSLCount" type="number" min="1" max="10" value="1" style="width:5rem" /></label>
              <label><input id="labSLAllowFib" type="checkbox" checked /> Fib</label>
              <label><input id="labSLAllowPct" type="checkbox" checked /> Percent</label>
              <label><input id="labSLAllowEMA" type="checkbox" /> EMA</label>
              <label title="Pourcentage SL (si Percent)">Min % <input id="labSLPctMin" type="number" min="0" step="0.1" value="0.5" style="width:5rem" /></label>
              <label title="Pourcentage SL (si Percent)">Max % <input id="labSLPctMax" type="number" min="0" step="0.1" value="5.0" style="width:5rem" /></label>
            </div>
            <div id="labSLFibWrap" style="display:none; gap:10px; flex-wrap:wrap; margin-bottom:6px;">
              <label><input type="checkbox" data-r="0.236" />0.236</label>
              <label><input type="checkbox" data-r="0.382" checked />0.382</label>
              <label><input type="checkbox" data-r="0.5" checked />0.500</label>
              <label><input type="checkbox" data-r="0.618" checked />0.618</label>
              <label><input type="checkbox" data-r="0.786" />0.786</label>
              <label><input type="checkbox" data-r="1" />1.000</label>
              <label><input type="checkbox" data-r="1.272" />1.272</label>
              <label><input type="checkbox" data-r="1.382" />1.382</label>
              <label><input type="checkbox" data-r="1.414" />1.414</label>
              <label><input type="checkbox" data-r="1.618" />1.618</label>
            </div>
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <strong>Cache</strong>
              <label>TTL (jours) <input id="labCacheTTL" type="number" min="1" max="365" value="14" style="width:6rem" /></label>
              <label>Max entrées <input id="labCacheMax" type="number" min="100" max="20000" step="100" value="2000" style="width:8rem" /></label>
              <button id="labCachePurge" class="btn" title="Supprimer pivots/signaux mis en cache">Purger cache</button>
            </div>
          </div>
          <div id="labSummary" style="margin-bottom:10px; color:var(--muted);"></div>
          <!-- KPIs + Logs inline (no extra tab/dock) -->
          <div class="lab-panels">
            <div class="kpi-cards">
              <div class="kpi-item"><div class="kpi-label">Score</div><div id="kpiScore" class="kpi-value">—</div></div>
              <div class="kpi-item"><div class="kpi-label">PF</div><div id="kpiPF" class="kpi-value">—</div></div>
              <div class="kpi-item"><div class="kpi-label">Win%</div><div id="kpiWin" class="kpi-value">—</div></div>
              <div class="kpi-item"><div class="kpi-label">Max DD</div><div id="kpiDD" class="kpi-value">—</div></div>
            </div>
            <div class="log-panel">
              <div class="card-header" style="margin-bottom:6px; display:flex; align-items:center; justify-content:space-between; gap:8px;">
                <strong>Logs</strong>
                <span id="labRunStatus" style="color:var(--muted); font-size:12px;">Idle</span>
              </div>
              <pre id="labLog" style="margin:0; max-height:30vh; overflow:auto; white-space:pre-wrap; background:var(--header-bg); padding:6px; border-radius:6px;">—</pre>
            </div>
          </div>
          <div style="overflow:auto; max-height:60vh; margin-top:10px;">
            <table class="lbc-table" style="width:100%">
              <thead>
                <tr>
                  <th>#</th><th>Nom</th><th>Gen</th><th>Paramètres</th><th>Score</th><th>PF</th><th>P&L</th><th>Cap. final</th><th>Trades</th><th>Win%</th><th>Avg RR</th><th>Max DD</th><th>Actions</th>
                </tr>
              </thead>
              <tbody id="labTBody"><tr><td colspan="13">Aucune donnée</td></tr></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <span style="color:var(--muted);">Les données sont agrégées à partir des optimisations effectuées (symbole courant + TF sélectionné).</span>
        </div>
      </div>
    </div>

    <!-- Lightweight Charts vendored (UMD) for static deploy -->
    <script src="vendor/lightweight-charts.standalone.production.js"></script>
    <!-- Supabase UMD client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script src="src/supa_ui.js"></script>
    <script src="src/main.js"></script>
  </body>
</html>
